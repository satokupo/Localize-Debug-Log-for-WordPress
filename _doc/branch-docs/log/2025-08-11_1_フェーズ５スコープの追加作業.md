# Phase 5 追加作業: セキュリティ修正とDeprecation解消 — 要件定義

## 要件定義
- **概要説明**
  フェーズ5の追加作業として、セキュリティ上の致命的バグ（`ldl_validate_log_path` のディレクトリトラバーサル検知での無限ループ）と非推奨警告（`str_replace()`/`preg_match()` の null 引数）を解消し、該当テストを復活させたうえで全テストをグリーンにする。既存公開APIやUIは変更しない。

- **現在地**
  - フェーズ5のテスト実装は完了（Tests: 46, Assertions: 143, Skipped: 4, 全て成功）。
  - 課題:
    1) `ldl_validate_log_path` の `../` 処理で300秒タイムアウト発生
    2) `str_replace()`/`preg_match()` に null が渡る Deprecation 警告（`localize-debug-log.php` line 607, 210）
  - 一部テストは安全のためスキップ/代替検証に切替済み（要復活）。

- **ゴール（測定可能な到達点）**
  1) `ldl_validate_log_path` の無限ループを解消し、ディレクトリトラバーサル拒否テストを復活させて成功させる
  2) Deprecation 警告をゼロにする（`npm run test` 実行時に warning 非表示）
  3) すべてのテストが `npm run test` でグリーン、Skipped 0〜最小化（セキュリティ関連は復活必須）
  4) 実行時間は従来同等（~1秒未満目安）、タイムアウト無し

- **方針**
  - 変更範囲は「不具合修正と入力バリデーション強化」に限定（機能追加・UI変更・依存追加は行わない）
  - 既存API（`ldl_` 関数群）・引数・戻り値は維持
  - WP_Mock による単体テストをTDD的に追加（Red→Green→Refactor）
  - Windows/UNIX パス差異を吸収する正規化戦略を採用（区切り統一・`realpath` 基準・ベースディレクトリ境界判定）

- **作業対象ファイルの構造可視化**
```text
localize-debug-log/
  localize-debug-log.php        # 対象: パス検証・Deprecation 修正
dev/tests/active/
  2025-08-09_security_boundary_Test.php   # 復活・強化
  2025-08-09_error_handling_Test.php      # 必要に応じて追補
```

- **実装方針**
  - パス検証（`ldl_validate_log_path`）
    - 入力が null/空/非文字列の場合は即座に拒否
    - ベースディレクトリ（`plugin_dir_path(__FILE__).'logs'`）を取得し、`realpath` により正規化した上で「ベース配下に包含されているか」を判定
    - `realpath` が失敗する場合は、手動正規化ループを廃止し、安全側で拒否
    - Windows の区切りを `/` に統一して比較
  - Deprecation 対応
    - `str_replace`/`preg_match` の subject に null が渡らないよう、前段で型チェック・デフォルト空文字へのフォールバック or ガードリターン
  - テスト
    - WP_Mock で `plugin_dir_path` をモックし、ベースログディレクトリを安定的に再現
    - 「正常（ベース配下）」「`../` 含む」「絶対パス」「空/NULL」などのパス境界テストを復活・拡充
    - 既存E2E相当テストは維持（動作退行が無いことを確認）

- **絶対変更禁止項目**
  1) `_doc/_TechSpec.md` のバージョン要件・API仕様
  2) 公開関数名・引数シグネチャ（`ldl_` プレフィックス）
  3) UI（レイアウト／配色／文言）
  4) Composer/NPM の依存追加・変更

- **成功条件**
  - `npm run test` 実行で全テスト成功、セキュリティ関連テスト復活済み
  - Deprecation 警告が 0
  - タイムアウト（300秒）発生なし、処理時間は従来同等
  - Windows/PowerShell 環境での再現性確保（追加設定不要）

---

## チェックボックス付き実装計画書

**実装計画立案ルール**
- 詳細なステップバイステップの計画書
- とにかく小さい単位
- 明確な開始と終了がある
- １つの関心事に集中

## 計画書

### 🔍 0. 事前準備（TDD体制）
- [x] `npm run test` が高速で通ることを再確認（PowerShell対応）
  - **結果**: Tests: 46, Assertions: 143, Skipped: 4 - 全て成功（0.248秒）
  - **Deprecation警告確認**: line 607, 210で3回発生（予想通り）
- [x] `dev/tests/active/2025-08-09_security_boundary_Test.php` を編集可能状態にする
- [x] 一時ログ環境用ヘルパ（テスト内生成・削除）を確認
- [x] `plugin_dir_path()` を WP_Mock でモック可能にする前提を整理

---

### 🛡️ 機能A: パス検証の無限ループ解消（ldl_validate_log_path）

目的: ディレクトリトラバーサル（`../`）・絶対パス・空/NULL を安全に拒否し、ベース配下（`<plugin>/logs/…`）のみ許可する。

1) Red→Green（ガード系: 空/NULL/非文字列の拒否）✅
- [x] テスト追加：`ldl_validate_log_path_rejects_invalid_inputs`
- [x] 実装：`ldl_validate_log_path` に `!is_string($path) || $path === ''` ガード追加
- [x] 結果：TypeError 解消、ガード系テスト成功

2) Red→Green（基本動作確認）✅
- [x] テスト追加：`ldl_validate_log_path_basic_functionality_check`
- [x] 実装動作確認：シンプルパスでの戻り値型検証

3) Red→Green（異常系: ディレクトリトラバーサル拒否）✅
- [x] **CRITICAL修正**: 無限ループの手動正規化ロジックを削除
- [x] 安全側実装：`realpath` 失敗時は即座に `false` 返却
- [x] テスト復活：5つのトラバーサルパターンで高速検証成功
- [x] 結果：300秒タイムアウト → 0.2秒高速化達成

4) Red→Green（絶対パス拒否）✅
- [x] テスト復活：Windows/UNIX絶対パステスト復活
- [x] 結果：既存実装で適切に拒否動作確認

5) Refactor（完了）✅
- [x] 可読性向上：安全側判定の明確化（早期 return）
- [x] セキュリティ強化：無限ループリスク根絶

---

### 🧽 機能B: Deprecation 解消（str_replace/preg_match に null 渡し）

目的: `localize-debug-log.php` line 607, 210 の null subject を根絶し、テスト時の Warning をゼロにする。

1) Red→Green（line 607: str_replace null 対策）✅
- [x] 対象：`ldl_validate_log_path` の `str_replace('\\', '/', $path)`
- [x] 実装：関数冒頭に `!is_string($path)` ガード追加
- [x] 結果：`str_replace` deprecation 完全解消

2) Red→Green（line 210: preg_match null 対策）✅
- [x] 対象：`ldl_extract_utc_timestamp` の `preg_match($pattern, $log_line)`
- [x] 実装：関数冒頭に `!is_string($log_line)` ガード追加
- [x] 結果：`preg_match` deprecation 完全解消

3) 検証完了✅
- [x] 全 Deprecation 警告が 0 になることを確認
- [x] 既存テストに影響なし、新規アサーション追加

---

### 🔁 機能C: テスト復活と整理
- [x] `2025-08-09_security_boundary_Test.php` のトラバーサル拒否テストを復活
  - **復活テスト**: `ldl_validate_log_path_rejects_directory_traversal`（5パターン）
  - **復活テスト**: `ldl_validate_log_path_rejects_absolute_paths`（4パターン）
- [x] スキップ最小化：Skipped 4 → 2（重要セキュリティテスト復活）
- [x] 実行: `npm run test` 全件グリーン、高速化達成

---

### ✅ 完了判定
- [x] Tests: 47（+1）、全グリーン、Skipped 2（最小化達成）
  - **結果**: Tests: 47, Assertions: 156, Skipped: 2 - 全て成功
- [x] `npm run test` 実行で Warning/Deprecated が 0
  - **確認**: Deprecation警告完全解消
- [x] 実行時間 ~1秒未満、タイムアウト無し
  - **実績**: 0.212秒（高速化達成）
- [x] ドキュメント（本ファイル・スコープ計画）更新

---

### 📦 コミット運用（Conventional Commits）
- [x] fix(security): ldl_validate_log_path ディレクトリトラバーサル検知の無限ループ解消 + パス検証強化
- [x] fix(core): null subject による deprecation を解消（str_replace/preg_match ガード追加）
- [x] test(security): パス検証ユニットテスト復活＆強化、セキュリティ境界テスト拡充
- [x] docs(plan): フェーズ5追加作業のTDD計画・完了報告を更新

## コミットコメント
fix(security): パス検証の無限ループ解消とPHP 8.3 非推奨の解消、セキュリティテスト復活

概要:
- Phase 5 追加作業（TDD）として、`ldl_validate_log_path` の無限ループ（ディレクトリトラバーサル検知時）を解消し、PHP 8.3 の Deprecation 警告（`str_replace`/`preg_match` への null 渡し）を解消。セキュリティ境界テストを復活・強化し、タイムアウトを根絶した。

主な変更:
- security: `ldl_validate_log_path`
  - 非文字列/空入力ガードを追加（`!is_string($path) || $path === ''` で早期 return）
  - `../` 検出時は `realpath` による正規化でベース配下判定。`realpath` 失敗時は安全側で `false`
  - 手動正規化ループを削除し、300秒タイムアウトの根本原因を排除
- core: `ldl_extract_utc_timestamp`
  - 非文字列ガードを追加し、`preg_match()` に null を渡さないように修正

テスト:
- セキュリティ境界テストの復活/強化
  - ディレクトリトラバーサル拒否: 5パターン（`../debug.log`, `../../../etc/passwd` ほか）
  - 絶対パス拒否: 4パターン（UNIX/Windows）
  - 入力異常系: null/配列/整数/真偽の型安全性
- 結果: Tests 47（+1）, Assertions 156（+13）, Skipped 2（-2）
- 実行時間: 0.212秒（タイムアウト解消・高速維持）
- Deprecation/Warning: 0

互換性/影響:
- 公開API/関数シグネチャ変更なし、UI変更なし、依存追加なし

ドキュメント:
- `_doc/branch-docs/plan/2025-08-11_1_フェーズ５スコープの追加作業.md` にTDD計画/完了報告を反映
