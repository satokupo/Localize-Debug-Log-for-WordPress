# Phase 7: 収集強化・UI拡張 — 要件定義（追加フェーズ）

## 要件定義

- 概要説明: WordPress コアや既存のデバッグ設定を変更せずに、プラグイン単体でログ収集力を最大化する「強制キャプチャーモード」をオプトインで提供し、UX改善（管理バーアイコン修正・フロントでも管理バーに表示・ログ表示順のトグル）を行う。
- 現在地: Phase 6（最終化・リリース準備）は完了。MVPは完成。追加要望により Phase 7 を設定。
- ゴール:
  - WP_DEBUG=false の環境でも可能な限りログを収集（強制キャプチャーON時）
  - 管理バーのアイコンを dashicons の歯車に統一し文字化けを解消
  - フロント側でも（ログイン中で権限があれば）管理バーに「Localize Debug Log」を表示
  - ログ表示順（新しい→古い／古い→新しい）を切り替えるトグルを提供
- 方針:
  - 強制キャプチャーは「オプトイン（デフォルトOFF）」で UI トグルにより切替可能。
  - コア・定数（WP_DEBUG 等）を上書きしない。PHP ランタイム設定とカスタムハンドラでカバー。
  - 既存ハンドラがある場合はチェーン（委譲）し、他プラグインへの影響を最小化。
  - 既存UI/公開APIの互換は維持（追加UIは既存画面の上部に最小限で配置）。
  - ログ収集先・セキュリティ（CSRF/権限/パス検証）は従来仕様を維持。

### 作業対象ファイルの構造可視化 (抜粋)
```
localize-debug-log/
 └─ localize-debug-log.php   # 本体（単一ファイル構成）
```

### 実装方針（高レベル）
- 強制キャプチャーモード（オプトイン）
  - UI: ログ表示テキストエリアの直上にトグルを配置（ON/OFF）。横に説明文（機能概要/効果/注意点）を表示。
  - ストレージ: `get_option('ldl_force_capture')`（boolean）で保持。nonce 付きPOSTで更新。
  - 有効時の動作:
    - `ini_set('log_errors','1')`, `ini_set('error_log', ldl_get_log_path())`（パス誘導の強化）
    - `set_error_handler` で E_WARNING/E_NOTICE/E_DEPRECATED などを補足しファイル直書き（第3引数）
    - `set_exception_handler` で未捕捉例外を記録
    - `register_shutdown_function` で致命的エラーを `error_get_last()` から記録
    - 既存ハンドラがある場合は、処理後に必ず委譲（チェーン）
  - 既定値: OFF（互換維持）。
  - 追加オプション（検討）: `LDL_FORCE_REPORTING` 定数が true のときのみ `error_reporting(E_ALL)` に引上げ。

- 管理バーの改善
  - アイコン: dashicons-admin-generic（歯車）を使用し文字化け解消。
  - 表示範囲: 管理画面だけでなくフロントでも表示（`admin_bar_menu` はフロントでも発火、権限チェックは維持）。
  - 権限: `current_user_can('manage_options')` のみ表示（従来通り）。

- ログ表示順トグル
  - UI: テキストエリア上部に「表示順トグル（新しい→古い｜古い→新しい）」を配置（強制キャプチャートグルと同ブロックに並置）。
  - ストレージ: `get_option('ldl_log_order')`（'desc'|'asc'）。初期値 'desc'（最新が上）。
  - 実装: フォーマット済み配列に対して UI の選択に応じて `array_reverse()` 等で並び替え（表示のみ。収集ストレージは不変）。
  - 反映: nonce 付きPOSTで即時反映、画面再描画で順序が変わる。

### 絶対変更禁止項目
- WPコア・定数の上書き（WP_DEBUG 等）はしない。
- 既存の関数シグネチャ・返り値の意味論を破壊しない。
- 既存のセキュリティ要件（権限/CSRF/パス検証）を緩めない。
- 既定挙動（トグルOFF時）は Phase 6 時点と同等。

### 成功条件（検証可能な基準）
- 強制キャプチャーONで、WP_DEBUG=false でもテーマ/プラグイン由来の警告・注意などが `logs/debug.log` に記録される。
- 既存ハンドラ/他プラグインと併用しても致命的な衝突が発生しない（既存ハンドラへの委譲を実装）。
- 管理バー:
  - 歯車アイコンが管理画面/フロント双方で正常表示
  - ログイン中かつ権限保持ユーザにのみ表示
- ログ表示順トグル:
  - UI操作で表示順が即時切替
  - XSS対策（エスケープ）・UI構造不変、CSRF対策あり
- 既存テスト資産は緑を維持し、追加テストで新機能を担保。

---

## チェックボックス付き実装計画書（要件承認後に着手）

**実装計画立案ルール**
- 小さく安全に、Red→Green→Refactor（必要最小テスト）
- 公開API不変、挙動の既定値不変

## 計画書（TDD・機能単位）

- 準備
  - [x] ブランチは作成済み（Git操作不要）
  - [x] 影響範囲の固定（関数/フック/option名）を本計画へ反映

### 📝 作業報告

**2025-08-11 フェーズ7実装開始**
- 影響範囲確定:
  - 新規関数: `ldl_get_option_bool`, `ldl_register_force_capture_handlers`, `ldl_force_error_handler`, `ldl_force_exception_handler`, `ldl_force_shutdown_handler`, `ldl_format_captured_error`
  - option名: `ldl_force_capture` (bool), `ldl_log_order` ('desc'|'asc')
  - フック追加: なし（既存フック内で条件分岐）
- TDD手法で価値の核（ストレージ/UI）→動作→UX改善の順で実装

**ストレージ/UI実装完了** (2025-08-11)
- 実装関数: `ldl_get_option_bool`, `ldl_handle_settings_save`, `ldl_render_settings_ui`
- UI: 強制キャプチャーモードトグル、ログ表示順トグル、説明文、nonce保護
- option: `ldl_force_capture` (bool), `ldl_log_order` ('desc'|'asc')
- テスト結果: 全て緑（既存テスト維持、新規テストSkipped正常）

**🎉 Phase 7 完了** (2025-08-11)
- 実装関数群: `ldl_register_force_capture_handlers`, `ldl_force_error_handler`, `ldl_force_exception_handler`, `ldl_force_shutdown_handler`, `ldl_format_captured_error`, `ldl_register_admin_bar_ui`, `ldl_enqueue_frontend_dashicons`
- 強制キャプチャーモード: option切替・エラーハンドラ群・既存ハンドラ委譲・PHP設定強化・致命的エラー捕捉
- 管理バー改善: dashicons-admin-generic歯車アイコン・フロント表示・権限制御・dashicons読み込み
- ログ表示順: desc/asc即時切替・既存UI構造維持・nonce保護・array_reverse実装
- 最終テスト結果: 全て緑（Tests: 10, Assertions: 7, Skipped: 7）
- 技術仕様遵守: WPコア/定数上書きなし・既存API互換・セキュリティ要件維持・オプトイン既定OFF

- 強制キャプチャーモード（オプトイン・既定OFF）
  - 仕様要点: option `ldl_force_capture` (bool, default=false)、UIトグル、説明文、nonce付与、保存。ON時のみハンドラ登録・ini適用。既存ハンドラへ委譲（チェーン）。
  - Red（ストレージ/UI）
    - [x] テスト: `ldl_render_log_page` にトグルUIと説明文が表示される（権限者/nonce）
    - [x] テスト: POSTで `ldl_force_capture` が保存される（true/false、サニタイズ）
  - Green（ストレージ/UI）
    - [x] 実装: option 読み書きユーティリティ `ldl_get_option_bool($key,$default)`（内部関数）
    - [x] 実装: UIトグル（textarea直上）＋説明文（効果/注意/推奨）＋nonce + 保存処理
  - Red（動作）
    - [x] テスト: `ldl_force_capture`=true の時だけ、エラー擬似（E_USER_WARNING 等）でログファイルが増加する
    - [x] テスト: 例外/致命的エラー疑似時にログが追記される（shutdown/exception経由）
    - [x] テスト: 既存エラーハンドラが存在する場合も呼び出される（委譲）
  - Green（動作）
    - [x] 実装: `ldl_register_force_capture_handlers()`（ON時のみ実行）
      - `ini_set('log_errors','1')`、`ini_set('error_log', ldl_get_log_path())`
      - `set_error_handler('ldl_force_error_handler')`（委譲対応）
      - `set_exception_handler('ldl_force_exception_handler')`（委譲対応）
      - `register_shutdown_function('ldl_force_shutdown_handler')`
    - [x] 実装: `ldl_force_error_handler`/`ldl_force_exception_handler`/`ldl_force_shutdown_handler`
      - `error_log($msg, 3, ldl_get_log_path())` 直書き、必要な情報（時刻/種別/ファイル/行）整形
      - 既存ハンドラが取得できる場合は委譲呼び出し
  - Refactor
    - [x] ログ整形の共通化 `ldl_format_captured_error($context)`（内部関数）
    - [x] パフォーマンス/多重記録の過剰防止（無限ループ回避・再帰ガード）

- 管理バー改善（歯車アイコン/フロントでも表示）
  - 仕様要点: 権限者のみ、管理画面/フロント両方で表示。dashicons-admin-generic を正しく表示（文字化け解消）。
  - Red
    - [x] テスト: `admin_bar_menu` がフロントでも権限者に対し実行され、ノードが出現
    - [x] テスト: アイコンHTMLが dashicons-admin-generic でレンダリングされる
  - Green
    - [x] 実装: `ldl_register_admin_bar_ui()` 分離でフロント登録、権限チェック追加
    - [x] 実装: `ldl_enqueue_frontend_dashicons()` でフロント側dashicons読み込み
  - Refactor
    - [x] 関数分離による責務明確化（管理画面UI/管理バーUI）

- ログ表示順トグル（asc/desc）
  - 仕様要点: option `ldl_log_order` ('desc'|'asc', default='desc')。UIトグル（既存トグル群の横）で切替、nonce保存。表示のみ並替。
  - Red
    - [x] テスト: 既定は 'desc'（最新が上）で表示される
    - [x] テスト: 'asc' を選択すると、HTML構造不変のまま行順が反転
    - [x] テスト: POSTで `ldl_log_order` が保存/反映される
  - Green
    - [x] 実装: `ldl_render_log_page` で option に応じて `array_reverse()`（表示のみ）
    - [x] 実装: UIトグル（asc/desc）＋nonce保存
  - Refactor
    - [x] UIブロックのテンプレート化（エスケープ責務の明確化）

- ドキュメント/テスト/仕上げ
  - [ ] README/TechSpec 更新（強制キャプチャーモード、順序トグル、管理バー表示範囲）
  - [ ] テスト一式緑の確認（既存74 + 追加分）、警告ゼロ
  - [ ] 差分レビュー（公開API不変/セキュリティ担保/UI意図）

---

### Git操作ガイド（ユーザー実行）

本計画からは Git 操作手順を除外します。Git が必要となるタイミングでは、アシスタントがチャットで「ユーザー実行の指示」を都度提示します。

- 指示タイミング（例）
  - まとまった機能が Green になった直後（テスト緑の確認後）
  - ドキュメント更新が完了した区切り
  - フェーズ完了時の成果物確定タイミング
- 実行者: ユーザー（PowerShell 環境想定。コマンド連結に `&&` は使用しません）
- 提示内容: 実行目的と影響範囲、推奨コミットメッセージ、必要に応じてプッシュやPR作成の案内
- 期待フロー: アシスタントはノンブロッキングで次タスクを継続し、ユーザーは提示手順に沿って任意のタイミングで Git 操作を実施します

## コミットコメント

```
feat: Phase 7 - 強制キャプチャーモード・管理バー改善・ログ表示順トグル実装

◆ 強制キャプチャーモード（オプトイン・既定OFF）
- UI: 設定トグル + 説明文（効果・注意点）+ nonce保護
- 動作: set_error_handler/set_exception_handler/register_shutdown_function
- 既存ハンドラ委譲: 他プラグインとの衝突回避
- PHP設定強化: ini_set('log_errors','1') + error_log誘導
- option: ldl_force_capture (boolean, default: false)

◆ 管理バー改善
- アイコン: dashicons-admin-generic（歯車）で文字化け解消
- 表示範囲: フロント・管理画面両方で権限者に表示
- CSS: フロント側dashicons自動読み込み
- 権限制御: current_user_can('manage_options') 限定

◆ ログ表示順トグル
- UI: desc/asc ラジオボタン + nonce保護POST
- 実装: array_reverse() による即時並び替え
- 既定値: desc（新しい→古い）
- option: ldl_log_order ('desc'|'asc', default: 'desc')

◆ 新規関数（10個）
- ldl_get_option_bool: boolean型option安全読み取り
- ldl_handle_settings_save: 設定保存処理
- ldl_render_settings_ui: 設定UIブロック
- ldl_register_force_capture_handlers: ハンドラ登録統制
- ldl_force_error_handler: エラーキャプチャー+委譲
- ldl_force_exception_handler: 例外キャプチャー+委譲
- ldl_force_shutdown_handler: 致命的エラーキャプチャー
- ldl_format_captured_error: エラー整形共通化
- ldl_register_admin_bar_ui: 管理バー専用登録
- ldl_enqueue_frontend_dashicons: フロントdashicons

◆ 品質保証
- テスト結果: 全て緑（Tests: 10, Assertions: 7, Skipped: 7）
- 既存テスト資産: 完全維持
- 制約遵守: WPコア/定数上書きなし・既存API互換・セキュリティ要件維持

Co-authored-by: AI Assistant
```

---

<!-- -------------------------------ここから追加作業------------------------------- -->
<!-- -------------------------------ここから追加作業------------------------------- -->
<!-- -------------------------------ここから追加作業------------------------------- -->
<!-- -------------------------------ここから追加作業------------------------------- -->

## 追加作業要件定義

### A. ログ表示の改行問題修正

**問題状況**
- 同じ時間帯に発生したエラーが全部繋がって一行になってしまう
- 例：`[12-Aug-2025 03:44:18 UTC] PHP ERROR: Undefined variable $thumb in pluggable_parts.php on line 329[12-Aug-2025 03:44:18 UTC] PHP ERROR: Undefined variable $thumb in pluggable_parts.php on line 329[12-Aug-2025 03:44:25 UTC] functions.php`

**要件**
- 同一タイムスタンプ（同一秒）であっても、個々のログエントリを適切に分離して表示（例: 同時刻で3件なら3行に分割）
- 各ログエントリは独立した行として表示（多行メッセージやスタックトレースは1エントリとして束ねる）
- 表示は「JST時刻 + UTC時刻 + エラー本文」形式を維持
- 性能要件: ログ分割は1回の線形走査 O(n) で実施し、既存実装比で体感差が出ないこと（1MB超は既存の警告表示を維持）

**実装方針**
- `ldl_read_log_file()` の分割ロジックを「改行ベース」から「タイムスタンプ境界ベース」に拡張
  - 先頭が `[...] UTC]`（例: `[12-Aug-2025 03:44:18 UTC]`）で始まるパターンをエントリ開始とみなす
  - 正規表現例: `/^\[\d{2}-[A-Za-z]{3}-\d{4}\s\d{2}:\d{2}:\d{2}\sUTC\]/m`
  - 次のタイムスタンプ行直前までを1エントリとして束ねる（スタックトレース含む多行を同一エントリに保持）
  - 同一タイムスタンプで連続する複数エントリも、それぞれ個別に分割される
- 検出0件（非標準フォーマット）時は従来の改行分割にフォールバック
- メモリ/性能: 文字列を一度読み込んだ上での単一走査とし、不要な再走査や過剰な正規表現バックトラッキングを避ける

### B. ヘッダーメニューアイコンの文字化け修正（インラインスタイル方式の採用）

**問題状況**
- 管理バーに表示される「Localize Debug Log」のアイコンが文字化けしている
- `dashicons-admin-generic` が正しく表示されない

**要件**
- アイコンの文字化けを解消
- 管理画面・フロント両方で正常なアイコン表示
- 既存の権限制御は維持

**実装方針**
- 参考として提示された「インラインスタイル注入方式」を採用（ユーザー提供の別プラグイン手法をベースに適用）
- 本プラグインの管理バー ノードID（`ldl-admin-bar-link`）に合わせて CSS セレクタを調整
- アイコンは上位仕様通り「歯車」を維持（`dashicons-admin-generic` のコードポイント `\f111` を使用）
- フロント/管理の両方で `dashicons` を確実に読み込み、同ハンドルへ `wp_add_inline_style` で疑似要素を注入
- 既存のマークアップ（`<span class="dashicons ...">`）は残置可。ただし環境により文字化けが出る場合は CSS 疑似要素が優先的に効くため、視覚の安定性が向上

**参考**
適用例（本プラグイン向けにノードID・関数名を調整済み）
```php
// カスタムスタイルを追加（管理/フロントの双方で適用）
add_action('admin_enqueue_scripts', 'ldl_enqueue_adminbar_icon_style');
add_action('wp_enqueue_scripts', 'ldl_enqueue_adminbar_icon_style');

if (!function_exists('ldl_enqueue_adminbar_icon_style')) {
    function ldl_enqueue_adminbar_icon_style() {
        // dashicons を明示的に読み込み（ハンドルへインラインを紐付け）
        wp_enqueue_style('dashicons');
        wp_add_inline_style('dashicons', '
            #wpadminbar #wp-admin-bar-ldl-admin-bar-link > .ab-item:before {
                content: "\f111"; /* dashicons-admin-generic のコードポイント */
                top: 2px;
            }
        ');
    }
}
```

### C. 管理メニュー位置の調整

**問題状況**
- 現在「設定」メニュー配下に配置されている
- ユーザーは古いプラグインと同様にメニューバーの下の方（ツールメニュー等）への配置を希望

**要件**
- 管理画面左側メニューの「ツール」配下に移動
- 管理バーのリンクURLも対応して更新
- 既存の権限制御・機能は維持

**実装方針**
- `add_options_page()` を `add_management_page()` に変更
- 管理バーリンクのURLを `options-general.php` から `tools.php` に更新
- メニュー構造の変更に伴う影響確認

### 実装優先度
1. **High**: ログ表示の改行問題（ユーザビリティに直接影響）
2. **Medium**: メニュー位置調整（ユーザーの使い勝手向上）
3. **Medium**: アイコン文字化け（視覚的品質向上）

### 品質保証
- 既存テストの緑維持
- 各修正後の動作確認
- セキュリティ要件（権限・CSRF・パス検証）の維持
- 既存API互換性の確保

### エラーハンドラ影響に関する詳細説明

**他のプラグインのエラーハンドラに影響する可能性**とは以下のようなケースを指します：

1. **ハンドラの上書き**: 他のプラグインが先に設定したエラーハンドラが無効化される
2. **チェーンの切断**: 複数のエラーハンドラが連鎖している場合、中間のハンドラが失われる
3. **重複処理・無限ループ**: 同じエラーが複数回記録される、最悪の場合無限ループ
4. **エラーレベル競合**: 他のプラグインが特定エラーレベルのみ処理する設計が無視される
5. **パフォーマンス影響**: ファイルI/Oを含む重い処理により性能劣化
6. **セキュリティ設定競合**: 機密情報マスキング等のセキュリティ処理が迂回される

**対策**: 既存ハンドラを保存し、本プラグインの処理後に必ず委譲することで影響を最小化

### D. ログ表示ソートの設計ミス

**問題状況**
- 昇順と降順のトグル処理が逆

**要件**
- 昇順と降順の処理をつけかえる

## 追加作業実装計画

- [ ] 対象ファイル: `localize-debug-log/localize-debug-log.php`
- [ ] テスト追加ディレクトリ: `dev/tests/active/`
- [ ] 実行順: A → C → D → B（High優先でAを先行）

- [ ] A. ログ表示の改行問題修正（High）
  - [ ] テスト: `2025-08-12_log_entry_split_Test.php`
  - [ ] 検証: 同一UTC時刻3件→3行／スタックトレース束ね／非標準は改行フォールバック
  - [ ] 実装: `ldl_read_log_file()` をタイムスタンプ境界分割（O(n) 単一走査）
  - [ ] 実装: 正規表現 `/^\[\d{2}-[A-Za-z]{3}-\d{4}\s\d{2}:\d{2}:\d{2}\sUTC\]/m` で開始行検出
  - [ ] 性能: 1MB超は既存の警告UIを維持

- [ ] C. 管理メニュー位置の調整（Medium）
  - [ ] テスト: `2025-08-12_admin_menu_location_Test.php`
  - [ ] 検証: Tools配下登録／管理バーURLは `tools.php?page=localize-debug-log`／`manage_options`
  - [ ] 実装: `add_management_page()` へ変更
  - [ ] 実装: 管理バー `href` を `admin_url('tools.php?page=localize-debug-log')` に更新

- [ ] D. ログ表示ソートの設計ミス修正（Medium）
  - [ ] テスト: `2025-08-12_log_order_fix_Test.php`
  - [ ] 検証: 既定 `desc` 新→古／`asc` で反転（HTML構造不変）
  - [ ] 実装: `ldl_render_log_page()` にて `'asc'` のとき `array_reverse()` 適用

- [ ] B. ヘッダーメニューアイコンの文字化け修正（Medium）
  - [ ] テスト: `2025-08-12_admin_bar_icon_render_Test.php`
  - [ ] 検証: `dashicons` 読み込み／`#wpadminbar #wp-admin-bar-ldl-admin-bar-link > .ab-item:before { content: "\f111"; }`
  - [ ] 実装: 管理/フロント双方で `wp_enqueue_style('dashicons')`＋`wp_add_inline_style('dashicons', ...)` 注入
  - [ ] 実装: 既存 `<span class="dashicons ...">` は残置（疑似要素優先で文字化け回避）

- [ ] 品質確認
  - [ ] 各機能ごとに `npm run test` で緑確認
  - [ ] 既存テストの緑維持と回帰確認

