# {{タイトル}}

## 要件定義

### 概要説明
- ログファイル `logs/debug.log` の初期状態と「削除」操作後の振る舞いを改善する。
- 初期状態では空ではなく、ユーザーに「削除ボタンで初期化してください」と案内を表示するテキストを格納。
- 「ログを削除」ボタン押下時は、空にはせず「初期化：yyyy-mm-dd アカウント名」という1行を自動挿入する。

### 現在地
- 既定では `logs/debug.log` が空（または存在しない）状態。
- 「ログを削除」ボタン押下後も空ファイルになる。

### ゴール
- 既定状態の `logs/debug.log` には、案内文（例: `ログ削除ボタンを押して初期化してください`）が格納されている。
- 「ログを削除」ボタン押下後は、既存ログ互換のUTCタイムスタンプを先頭とした1行が格納される（末尾改行あり）。
  - 例: `[{DD-MMM-YYYY HH:MM:SS UTC}] 初期化：YYYY-MM-DD {アカウント名}`
- 以降、通常のエラーログが追記されていく。

### 方針
- 先頭タイムスタンプはUTC固定（`[DD-MMM-YYYY HH:MM:SS UTC]`）。
- 併記日付は `YYYY-MM-DD`（`current_time('Y-m-d')`、無ければ `gmdate('Y-m-d')`）。
- アカウント名は `wp_get_current_user()` の `display_name` 優先、無ければ `user_login`。
- 初期化メッセージは日本語固定文言（多言語対応はスコープ外）。
- 既存の権限/CSRF/パス検証は維持（変更しない）。

### 作業対象ファイルの構造可視化(tree)
```
localize-debug-log/
 └─ localize-debug-log.php
```

### 実装方針（高レベル）
- 既定メッセージ付与（初回/空ファイル）
  - プラグイン初期化時（`ldl_safe_init` → `ldl_setup_error_log_redirection` 実行後）に、`logs/debug.log` の存在とサイズを確認。
  - ファイルが存在しない、またはサイズ0の場合、案内文 `ログ削除ボタンを押して初期化してください\n` を書き込む（追記ではなく上書き）。

- 削除後の初期化行の自動挿入（UTCタイムスタンプ先頭）
  - 既存の削除処理 `ldl_delete_log_file()` でクリア成功後に、
    - 先頭UTC: `gmdate('d-M-Y H:i:s') . ' UTC'` を `[... ]` で括る
    - 併記日付: `current_time('Y-m-d')`（無ければ `gmdate('Y-m-d')`）
    - ユーザー: `wp_get_current_user()`（`display_name`→`user_login`）
    - 出力: `"[{$utc}] 初期化：{$ymd} {$user}\n"`
  - 書き込み失敗時は処理自体は成功扱い（UX優先）。

### 絶対変更禁止項目
- 既存の権限チェック、CSRF検証、パス検証を弱めない。
- WordPress コア定数（`WP_DEBUG` 等）は上書きしない。
- 既存関数の公開シグネチャは変更しない（内部実装の追加のみ）。

### 成功条件
- 新規インストール/初期状態で `logs/debug.log` に案内文が1行出力されている。
- 「ログを削除」後、`初期化：YYYY-MM-DD {アカウント名}` の1行が出力される。
- 既存のUI（textarea表示/削除ボタン）は不変で、案内文または初期化行が表示される。
- 既存の自動テスト一式は緑を維持（必要なら期待値の微調整のみ）。

---

## チェックボックス付き実装計画書

**実装計画立案ルール**
- 詳細なステップバイステップの計画書
- とにかく小さい単位
- 明確な開始と終了がある
- １つの関心事に集中

## 計画書
- [ ] 対象ファイルの確認
  - [ ] `localize-debug-log/localize-debug-log.php`

- [ ] 既定メッセージ付与（初回/空ファイル）
  - [ ] `ldl_safe_init()` 内、ログ出力先設定完了後に `ldl_get_log_path()` を取得
  - [ ] ファイル不存在 or サイズ0 の場合、`file_put_contents($path, "ログ削除ボタンを押して初期化してください\n")`

- [ ] 削除後の初期化行の自動挿入（UTCタイムスタンプ先頭）
  - [ ] `ldl_delete_log_file()` でゼロクリア後に、以下を生成
    - [ ] `$utc = gmdate('d-M-Y H:i:s') . ' UTC';`
    - [ ] `$ymd = function_exists('current_time') ? current_time('Y-m-d') : gmdate('Y-m-d');`
    - [ ] `$user = function_exists('wp_get_current_user') ? (wp_get_current_user()->display_name ?: wp_get_current_user()->user_login) : 'unknown';`
  - [ ] `file_put_contents($path, "[{$utc}] 初期化：{$ymd} {$user}\n", FILE_APPEND | LOCK_EX)` を実行

- [ ] 動作確認
  - [ ] プラグイン有効化直後、`logs/debug.log` に案内文が出力される
  - [ ] 連続「ログを削除」押下で毎回 `初期化：YYYY-MM-DD {アカウント名}` が1行に保たれる（多重行にならない）
  - [ ] 既存UI/セキュリティ（権限/CSRF/パス検証）が影響を受けない

- [ ] 品質確認
  - [ ] `npm run test-all` を実行し、既存テストが緑であることを確認
  - [ ] 必要なら、初期状態/削除後の挙動に依存するテスト期待値を微修正（UI構造は不変）

---

## コミットコメント
{{実装チェックリストが完了後、ユーザーの明確な承認を得たあとでチャットに出力されたコミットコメントを記載}}
