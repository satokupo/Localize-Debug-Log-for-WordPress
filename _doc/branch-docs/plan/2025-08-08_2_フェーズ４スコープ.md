# フェーズ4: セキュリティ・権限制御 — スコープ要件定義（MVP）

## 要件定義

### 概要説明
Phase 4 では UI を変更せず、既存機能（ログ閲覧・削除）に対するセキュリティ強化を目的に、CSRF 保護の共通化とファイル操作の安全性向上（パス検証・排他制御）を実装する。権限制御は入口遮断（`admin_menu` 配下、`current_user_can('manage_options')`）で満たす前提とし、独自の権限抽象や追加ロールは行わない。

### 現在地（前フェーズの実装状況）
- Phase 3 完了: 管理画面 UI（メニュー／管理バー、ログ表示、削除、通知）実装済み
- 既存のセキュリティ実装:
  - CSRF: `ldl_render_log_page()` 内で `wp_nonce_field('ldl_delete_log_action','ldl_delete_nonce')` を出力、`ldl_handle_delete_request()` で `check_admin_referer()` 検証を実施
  - 権限: `current_user_can('manage_options')` による入口遮断
  - パス: ログパスは `ldl_get_log_path()` 固定（パス検証の共通化は未実装）
- 未実装/課題: ファイル操作時の明示的なパス検証、排他制御（LOCK_EX / flock）不十分、メソッド検証（POST限定）の明確化不足

  補足（用語統一・整合性メモ）:
  - 技術仕様書の権限記述は `current_user_can('administrator')` となっているが、実装の正解は能力ベースの `current_user_can('manage_options')`（Phase 3 で実装済み）。本フェーズ以降も `manage_options` を正とする。
  - CSRF ユーティリティ `ldl_csrf_protect` は新設であり、既存の nonce 名・フィールド名（`ldl_delete_log_action` / `ldl_delete_nonce`）を既定値として踏襲する（関数名の不整合はなし）。

### ゴール
1. CSRF 保護を共通ユーティリティ化し、発行・検証のインタフェースを統一する
2. ファイルアクセス制御を強化し、`logs/` 配下以外の操作を論理的に不可能にする
3. ログ削除処理を排他制御（LOCK_EX 相当）で安全化し、レースコンディションや TOCTOU を低減する
4. 既存の UI/挙動・バージョン要件・公開 API（関数名・フック）を破壊しない

### 方針（ハイレベル設計）
- WordPress 標準 API のみ使用（外部依存なし）
- 関数プレフィックスは全て `ldl_`、メインファイルは単一構成を維持
- UI・フック構成は変更せず、内部実装（安全化）に限定
- 既存の nonce 名・フィールド名（`ldl_delete_log_action` / `ldl_delete_nonce`）を踏襲

### スコープ
- 含む
  - CSRF 発行・検証の共通化ユーティリティ化（新規: `fn: ldl_csrf_protect`）
  - ファイルパス検証（`realpath`）の共通化（新規: `fn: ldl_validate_log_path`）
  - ログ削除処理の排他化（`file_put_contents(..., '', LOCK_EX)` などの排他制御）
  - 削除処理の HTTP メソッド検証（POST 限定）
  - 失敗時の通知文言の一貫性維持（既存通知関数を使用しつつ理由分類を拡張可能な形で返却）
- 含まない
  - 新規 UI／UX（レイアウト・色・フォント・文言）変更
  - 役割・権限モデルの追加や抽象化（`manage_options` 維持）
  - ログの読み出し方式やフォーマット変更（Phase 2 の整形仕様維持）
  - E2E/Unit テストの拡充実装（Phase 5 で対応）

### 対象機能・関数（新規/変更）
- 新規
  - `fn: ldl_csrf_protect($action, $field)`
    - 役割: nonce の発行・検証をまとめた軽量ヘルパ（表示用・検証用の2用途サポート）
    - 既定値: `$action='ldl_delete_log_action'`, `$field='ldl_delete_nonce'`（Phase 3 の実装に一致）
  - `fn: ldl_validate_log_path($path)`
    - 役割: `realpath($path)` を `plugin_dir_path(__FILE__) . 'logs'` の実体パス配下に限定するガード
    - 返り値: 妥当な場合のみ正規化済みの絶対パス、失敗時は `false`
- 変更
  - `fn: ldl_handle_delete_request()`
    - POST メソッドのみ処理、`ldl_csrf_protect` による nonce 検証、`ldl_validate_log_path` によるパス妥当性確認
  - `fn: ldl_delete_log_file()`
    - 排他制御（`LOCK_EX`）でのゼロクリア方式へ安全化（結果として空ファイルを保証）
    - 事前に `ldl_validate_log_path` でパス妥当化

### セキュリティ要件（詳細）
- CSRF 保護
  - 発行: ログ削除フォームにて `wp_nonce_field('ldl_delete_log_action','ldl_delete_nonce')` を継続
  - 検証: POST 受信時に `check_admin_referer('ldl_delete_log_action','ldl_delete_nonce')`
  - 共通化: `ldl_csrf_protect` を介して実行し、将来の拡張（有効期限・エラー理由）に備える
- ファイルアクセス制御
  - パス検証: `realpath($candidate)` と `realpath(plugin_dir_path(__FILE__) . 'logs')` を比較し、前方一致で `logs/` 配下のみ許可
  - シンボリックリンク対策: `realpath` 不可時は拒否。比較はディレクトリ区切り考慮
  - 排他制御: 第一選択として `file_put_contents($path, '', LOCK_EX)` によりゼロクリアを実施。`LOCK_EX` が取得できない環境・状況では、`fopen('c+')` → `flock(LOCK_EX)` → `ftruncate(0)` → `fflush` → `flock(LOCK_UN)` → `fclose` へフォールバックする。
  - メソッド検証: 削除は POST のみ許可、GET アクセスは無視
  - エラーハンドリング: 失敗理由（permission / nonce / validate / io）を内部フラグで分類

### 非機能要件
- 互換性: WordPress 5.1+ / PHP 7.4+ を堅持、既存フック・関数シグネチャ互換
- 可読性: 単一ファイル内で小粒度関数化、`ldl_` プレフィックス統一
- 性能: 既存と同等（LOCK_EX によるオーバーヘッドは限定的）

### 制約・前提
- UI 変更なし、メニュー／管理バー／通知は既存のまま
- 外部ライブラリ／Composer 依存の追加禁止
- `debug_log_path` フィルタの既存仕様は変更しない

### 絶対変更禁止項目
1. UI（レイアウト／装飾／文言）の変更
2. バージョン要件・技術仕様（_TechSpec.md）の改変
3. 既存フック構成（`admin_menu`, `admin_bar_menu`, `admin_init`, `admin_notices`）の破壊
4. `ldl_` 以外の関数プレフィックス導入

### 成功条件（検証可能）
1. 不正な nonce／欠落時に削除処理が拒否される（通知は既存ロジックを継続使用）
2. `logs/` 配下以外のパスが論理的に到達不能（`ldl_validate_log_path` が false を返す）
3. 削除実行時に排他制御が有効で、結果として 0 バイトの `debug.log` が確実に存在
4. GET リクエストでは削除が実行されない
5. 管理者以外では削除が実行されない（Phase 3 の入口遮断と両立）

### 影響範囲
- 影響あり: `localize-debug-log/localize-debug-log.php`（内部実装の強化のみ）
- 影響なし: UI、README、ディレクトリ構成、テスト実装（Phase 5 で別途対応）

### リスクと対策
- 既存挙動との齟齬（unlink→再生成 から ゼロクリアへの変更）
  - 対策: 結果一貫性（空ファイル）を維持し、ドキュメント上の意味を不変とする
- プラットフォーム差による `LOCK_EX` の挙動差
  - 対策: `flock(LOCK_EX)` を用いたフォールバック手順を明文化し、取得不可時は安全に中止する

### 関連資料
- `_doc/_Milestone.md` Phase 4 セクション
- `_doc/_TechSpec.md` セキュリティ（CSRF / パス検証）
- `_doc/_Structure.md` ディレクトリ構成
- フェーズ3 作業ログ・マージログ（nonce 実装・UIの現状）

---

## チェックボックス付き実装計画書

**実装計画立案ルール**
- 詳細なステップバイステップの計画書
- とにかく小さい単位
- 明確な開始と終了がある
- １つの関心事に集中

## 計画書
{{ユーザーから要件定義の承認取得後、ここに実装計画立案}}

---

## コミットコメント
{{実装チェックリストが完了後、ユーザーの明確な承認を得たあとでチャットに出力されたコミットコメントを記載}}
