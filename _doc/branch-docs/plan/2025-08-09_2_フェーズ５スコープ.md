# Phase 5: テスト実装・品質保証 — スコープ要件定義

## 要件定義

### 概要説明
本フェーズは、既存機能（Phase 2〜4で実装済みのコア機能・UI・セキュリティ）に対する品質保証を目的に、単体テストおよびUI/E2Eテストを拡充する。新規のアプリ機能実装・UI変更・依存追加は行わず、テストコードの追加・整理・カバレッジ向上に限定する。

### 現在地（前フェーズの実装状況）
- Phase 2: ログ収集・整形のコア関数一式実装済み
- Phase 3: 管理画面UI（メニュー、管理バーリンク、ログ表示、削除、通知）実装済み
- Phase 4: セキュリティ強化（`ldl_csrf_protect`, `ldl_validate_log_path`、POST限定、排他制御）実装済み
- 既存テスト: `dev/tests/archive/` に Phase 2〜4 相当のテストが存在（PHPUnit + WP_Mock ベース）

### ゴール（測定可能な到達点）
1. 単体テストの網羅強化（タイムゾーン変換、ログ整形、セキュリティ境界の正常系/異常系）
2. UI／E2E 観点の振る舞い検証（画面遷移・削除フロー・通知表示の整合確認）
3. エラーハンドリングの再現テスト（ファイル権限エラー、1MB超ログ時の振る舞い）
4. すべてのテストが `npm run test` でグリーン、既存公開API（関数名・フック・UI）を一切破壊しない

### 方針（テスト設計ポリシー）
- フレームワークは既存の PHPUnit（および WP_Mock モック）を使用。新規依存追加は不可。
- テストは「機能単位（ユニット）」と「UI／E2Eに準じた振る舞い」へ分離して記述。
- 既存ファイル・関数名（`ldl_*`）を前提に、テストダブルで外部APIを最小限モック。
- 実装コードの変更は原則禁止。どうしても必要な場合はフェーズ逸脱と判断し提案止まりとする。

### 対象・非対象
- 対象
  - タイムゾーン処理: `ldl_get_wordpress_timezone`, `ldl_convert_utc_to_local`, `ldl_format_local_timestamp`
  - ログ整形: `ldl_read_log_file`, `ldl_extract_utc_timestamp`, `ldl_format_log_with_local_time`, `ldl_get_formatted_log`
  - セキュリティ境界: `ldl_csrf_protect`, `ldl_validate_log_path`, `ldl_handle_delete_request`, `ldl_delete_log_file`
  - UI／通知の振る舞い: `ldl_add_admin_menu`, `ldl_add_admin_bar_link`, `ldl_render_log_page`, `ldl_notice_delete_result`
- 非対象
  - 新規UI・UXの追加やレイアウト・文言変更
  - 新規依存（E2Eツール導入・ビルドツール変更・ランタイム変更）
  - コードリファクタリングや公開API変更

### 作業対象ファイルの構造可視化
```text
dev/tests/
  active/   # 新規・拡充テストの作成先（本フェーズの作業ディレクトリ）
  archive/  # 参考・既存（編集しない。必要に応じて参照）
  pending/  # 保留（本フェーズでは原則使用しない）
```

### 実装方針（テスト追加の粒度と想定クラス）
- 単体テスト
  - class: `Ldl_TimezoneProcessing_Test`（タイムゾーン設定未指定時の `gmt_offset` フォールバック含む）
  - class: `Ldl_LogFormatting_Test`（UTC抽出失敗時・混在行の扱い・先頭付加形式の検証）
  - class: `Ldl_SecurityBoundary_Test`（POST限定・nonce不一致・パス妥当性・排他失敗時の分岐）
- UI／E2E相当テスト（PHPUnit内での統合振る舞い検証の範囲で実施）
  - class: `Ldl_E2E_LogUiTest`（メニュー登録・画面描画・1MB超警告・削除後通知）
- エラーハンドリングテスト
  - class: `Ldl_ErrorHandling_Test`（ファイル権限エラー・サイズ判定エッジ・例外時フォールバック）

命名と配置
- ファイル名: `yyyy-mm-dd_名前_Test.php` 形式（例: `2025-08-09_timezone_processing_Test.php`）
- 配置: `dev/tests/active/`
- 実行: プロジェクトルートで `npm run test`

### 絶対変更禁止項目
1. 技術仕様書（`_doc/_TechSpec.md`）のバージョン要件・API仕様の変更
2. 関数プレフィックス・公開関数名（`ldl_`）の変更
3. UI（レイアウト／配色／文言／クラス名）の変更
4. 依存関係追加（Composer/NPM）

### 成功条件（検証手順と結果）
1. `npm run test` 実行で全テストが成功すること
2. タイムゾーン処理の境界（`timezone_string` 未設定時）と整形結果が期待どおりであること
3. セキュリティ境界の異常系: `permission` / `nonce` / `validate` / `io` の分類が意図通りに検出されること
4. UI相当の一連フロー（表示→削除→通知）が壊れていないこと（通知の成功/失敗表示を確認）
5. 1MB超ログ時の警告表示が維持されること

### 非機能要件
- 再現性: Windows/PowerShell 環境で `npm run test` だけで再現可能
- 可読性: テストごとに目的・前提・期待結果を明記
- 独立性: 各テストは副作用を残さない（グローバル変数は実行後リセット）

### リスクと回避
- モック過多による実挙動乖離 → UI相当テストで統合パスを最低限担保
- 権限・nonceの前提崩れ → 既存API呼出のみに限定し、関数名・引数は厳密一致

### 関連資料
- `_doc/_Milestone.md` Phase 5（本要件と一致）
- `_doc/_TechSpec.md`（フック・セキュリティ仕様）
- `_doc/_TestWorkflow.md`（命名規則と実行手順）
- `dev/tests/archive/`（過去テストの参照）

---

## チェックボックス付き実装計画書

**実装計画立案ルール**
- 詳細なステップバイステップの計画書
- とにかく小さい単位
- 明確な開始と終了がある
- １つの関心事に集中

## 計画書

### 🔍 0. 事前確認（ブロッカー排除）
- [ ] ルートでテスト実行できることを確認（`npm run test`）
- [ ] テスト作成場所が `dev/tests/active/` であることを確認
- [ ] 既存の `dev/tests/archive/` を参照し重複テストを避ける

---

### 🕒 1. タイムゾーン処理（ユニット）
- [ ] `dev/tests/active/2025-08-09_timezone_processing_Test.php` を作成
  - [ ] `ldl_get_wordpress_timezone`
    - [ ] `timezone_string` 設定時に同値を返す
    - [ ] `timezone_string` 未設定時に `gmt_offset` から `Etc/GMT%+d` を返す（正負オフセット双方）
  - [ ] `ldl_convert_utc_to_local`
    - [ ] 正常: `2025-08-06 12:34:56` (UTC) → 期待ローカル時刻
    - [ ] 異常: 不正フォーマット入力で空文字を返す
  - [ ] `ldl_format_local_timestamp`
    - [ ] 正常: `T YYYY/MM/DD HH:MM:SS` 形式を返す
    - [ ] 異常: 不正フォーマット入力で空文字
- [ ] 実行: ルートで `npm run test`（Green想定。Redの場合は要件・仕様の差異を精査し、実装変更が必要なら提案に留める）

---

### 🧾 2. ログ整形（ユニット）
- [ ] `dev/tests/active/2025-08-09_log_formatting_Test.php` を作成
  - [ ] `ldl_extract_utc_timestamp`
    - [ ] 正常: `[12-Aug-2025 01:23:45 UTC]` パターンからUTC抽出
    - [ ] 異常: 先頭が一致しない行では `null`
  - [ ] `ldl_format_log_with_local_time`
    - [ ] UTC抽出成功時にローカル時刻が行頭に付加される
    - [ ] 抽出不能行はそのまま維持
  - [ ] `ldl_read_log_file`
    - [ ] 存在しないファイルで空配列
    - [ ] 空行を除外して配列化
  - [ ] `ldl_get_formatted_log`
    - [ ] テンポラリに `localize-debug-log/logs/debug.log` を作成し、整形配列が返る
- [ ] 実行: `npm run test`

---

### 🛡️ 3. セキュリティ境界（ユニット）
- [ ] `dev/tests/active/2025-08-09_security_boundary_Test.php` を作成
  - [ ] `ldl_csrf_protect`
    - [ ] `field` モードで name=`ldl_delete_nonce` を含むHTMLを返す
    - [ ] `verify` モードで `check_admin_referer` の戻り値を透過
  - [ ] `ldl_validate_log_path`
    - [ ] 正常: `localize-debug-log/logs/debug.log` を許可
    - [ ] 異常: `../` を含むパスを拒否
  - [ ] `ldl_handle_delete_request`
    - [ ] GET は無視
    - [ ] 非管理者は `permission`
    - [ ] nonce 不一致は `nonce`
    - [ ] パス妥当性NGは `validate`
    - [ ] 正常時は `success=true`
  - [ ] `ldl_delete_log_file`
    - [ ] 正常: 実行後にサイズ0のファイルを保証
- [ ] 実行: `npm run test`

---

### 🖥️ 4. UI／E2E相当（PHPUnit内の統合振る舞い）
- [ ] `dev/tests/active/2025-08-09_e2e_log_ui_Test.php` を作成（class: `Ldl_E2E_LogUiTest`）
  - [ ] `ldl_add_admin_menu` が `add_options_page` を正しく登録（WP_Mock利用）
  - [ ] `ldl_render_log_page` の出力に以下を含む
    - [ ] `<textarea readonly>` が存在
    - [ ] ログ非存在時の情報通知
    - [ ] 1MB 超のときの警告通知（テスト時は一時的に1MB超ファイルを作成）
    - [ ] 削除フォームと nonce フィールドが出力
  - [ ] `ldl_notice_delete_result` が success / error で適切な notice を出力
- [ ] 実行: `npm run test`

---

### 🧪 5. エラーハンドリング（再現テスト）
- [ ] `dev/tests/active/2025-08-09_error_handling_Test.php` を作成
  - [ ] `ldl_delete_log_file` で検証NG時に `validate` を返す
  - [ ] （環境依存回避のため）I/O 例外は無理に再現せず、戻り値の安定性を確認
  - [ ] 大容量ログ時の `ldl_render_log_page` 警告出力を確認
- [ ] 実行: `npm run test`

---

### 🔁 6. リグレッション確認と整理
- [ ] 既存 `dev/tests/archive/` と重複する観点がないかを点検
- [ ] すべてGreenであることを再確認（`npm run test`）
- [ ] テストの命名・配置・副作用（一時ファイルの削除）を最終確認

---

### 🚩 7. 逸脱検知時の対応（提案止まり）
- [ ] もしテストで既存実装の不具合が疑われる場合:
  - [ ] 当該テストを `dev/tests/pending/` に移し、タイトル先頭に `[PENDING]` を付す
  - [ ] 影響範囲・再現手順・期待値を整理し、次フェーズまたは別チケットとして提案

---

## コミットコメント
{{実装チェックリストが完了後、ユーザーの明確な承認を得たあとでチャットに出力されたコミットコメントを記載}}
