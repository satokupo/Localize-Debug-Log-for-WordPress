# {{タイトル}}

## 要件定義

### 概要説明
- 同一タイミング（同一秒）で複数のログが出力される場合に、1行へ連結されて表示される問題を解消する。
- 連結は「収集段階（ファイル書き込み時）」で発生しており、表示段階の分割だけでは完全に補えないため、収集と表示の両面で対策する。

### 現在地（問題の具体例）
- 現状の表示例（不正な連結）:
  ```
  [JST 2025/08/12 15:33:02] [12-Aug-2025 06:33:02 UTC] PHP ERROR: Undefined variable $thumb in pluggable_parts.php on line 329[12-Aug-2025 06:33:02 UTC] PHP ERROR: Undefined variable $thumb in pluggable_parts.php on line 329[12-Aug-2025 06:33:02 UTC] PHP ERROR: Undefined variable $thumb in pluggable_parts.php on line 329[12-Aug-2025 06:33:04 UTC] functions.php
  ```
- 期待される表示:
  ```
  [JST 2025/08/12 15:33:02] [12-Aug-2025 06:33:02 UTC] PHP ERROR: Undefined variable $thumb in pluggable_parts.php on line 329
  [JST 2025/08/12 15:33:02] [12-Aug-2025 06:33:02 UTC] PHP ERROR: Undefined variable $thumb in pluggable_parts.php on line 329
  [JST 2025/08/12 15:33:02] [12-Aug-2025 06:33:02 UTC] PHP ERROR: Undefined variable $thumb in pluggable_parts.php on line 329
  [JST 2025/08/12 15:33:04] [12-Aug-2025 06:33:04 UTC] functions.php
  ```
- `debug.log` 実体が次のように連結されており、収集段階での区切り（改行）不足が原因:
  ```
  [12-Aug-2025 06:32:33 UTC] PHP ERROR: ...[12-Aug-2025 06:32:33 UTC] PHP ERROR: ...[12-Aug-2025 06:32:33 UTC] PHP ERROR: ...[12-Aug-2025 06:32:33 UTC] functions.php
  ```

### ゴール
- 収集段階で各ログエントリの後に必ず改行を付与し、ファイル内で1エントリ=1行（または1ブロック）となるように正規化する。
- 表示段階では、改行が欠落している既存ログでも正しく分割できるように、タイムスタンプ境界（`[DD-MMM-YYYY HH:MM:SS UTC]`）での分割を強化する（行頭に限定しない）。
- パフォーマンス劣化を招かない（O(n) 一回走査）。

### 方針
- 収集（書き込み）対策:
  - 強制キャプチャーの書き込み（`error_log($msg, 3, $path)`）時に、必ず末尾に `"\n"` を付与して出力する。
  - 追加要件（任意強化）: 直前が改行で終わっていない場合は先頭に改行を補う（ログ破損時の整合性向上）。
- 表示（読み取り）対策:
  - 既存の「タイムスタンプ境界分割」を、行頭 `^` に依存せず「任意位置の `[...] UTC]`」を境界と見なす方式に修正する。
  - スタックトレース等の多行メッセージは1エントリとして束ねる。
  - 非標準フォーマット・タイムスタンプ未検出時は改行分割にフォールバック。
- セキュリティ/互換性:
  - WPコア定数や既存のセキュリティ要件（権限/CSRF/パス検証）は変更しない。
  - 既存の公開APIシグネチャは不変。

### 作業対象ファイル（想定）
```
localize-debug-log/
 └─ localize-debug-log.php  # 強制キャプチャー書き込み/ログ読取の両方を内包
```

### 絶対変更禁止項目
- WPコア定数（`WP_DEBUG` など）の上書き禁止。
- 既存の権限/CSRF/パス検証ロジックの緩和禁止。
- 既存UIの構造・文言の大きな変更は行わない（必要最小限）。

### 成功条件（検証基準）
- 同一秒で3件のログが出力された場合、表示で3行に分割されること。
- 秒が異なるログ（例: `06:33:02` と `06:33:04`）が同一行に混在しないこと。
- 既存の連結済みログファイルでも、表示で正しく分割されること（タイムスタンプ境界での分割強化による）。
- 1MB程度のログでも体感性能が悪化しないこと（O(n) の一回走査）。

---

### アイコン表示（歯車）に関する修正要件
- 現状: CSS疑似要素による歯車表示が有効だが、もともとの文字化けアイコン（`<span class="dashicons ...">`）も同時に出てしまう。
- 要件:
  - 管理バーリンクの `title` から `dashicons` の `<span>` マークアップを除去し、ラベル文字列のみとする（疑似要素のみでアイコンを描画）。
  - `dashicons` スタイルは管理/フロントの両方で確実に読み込む（既存の読み込み処理は維持）。
  - 疑似要素は `#wpadminbar #wp-admin-bar-ldl-admin-bar-link > .ab-item:before { content: "\f111"; }` を使用し、歯車（dashicons-admin-generic）を安定表示する。
- 互換:
  - 旧テストが `dashicons-...` クラスを `title` 内に期待する場合は、テスト側の期待値更新が必要（本仕様では `<span>` を出力しない）。

---

## チェックボックス付き実装計画書

**実装計画立案ルール**
- 詳細なステップバイステップの計画書
- とにかく小さい単位
- 明確な開始と終了がある
- １つの関心事に集中

## 計画書

- [ ] 対象ファイルの確認
  - [ ] `localize-debug-log/localize-debug-log.php`

- [ ] 収集段階（書き込み）対策を実装
  - [ ] `ldl_format_captured_error()` の戻り値末尾に必ず `"\n"` を付与（重複改行は1つに正規化）
  - [ ] （任意強化）直前が改行で終端していない場合の先頭補完（必要時のみ）
  - [ ] `ldl_force_error_handler` / `ldl_force_exception_handler` / `ldl_force_shutdown_handler` からの書き込みが、常に改行で終わることを確認

- [ ] 表示段階（読み取り）対策を実装
  - [ ] `ldl_read_log_file()` のタイムスタンプ境界分割を「行頭依存」から「任意位置検出」に変更
    - [ ] 分割ルール: `preg_split('/(?=\[\d{2}-[A-Za-z]{3}-\d{4}\s\d{2}:\d{2}:\d{2}\sUTC\])/', $content)`
    - [ ] 各エントリの末尾空白を `rtrim()` で除去
    - [ ] 検出0件時は改行分割にフォールバック
  - [ ] 多行（スタックトレース等）は1エントリとして保持されることを確認

- [ ] 管理バーアイコンの純CSS化（文字化け要素の除去）
  - [ ] `ldl_add_admin_bar_link()` の `title` から `<span class="dashicons ...">` を削除し、ラベル文字列のみへ変更
  - [ ] `ldl_enqueue_adminbar_icon_style()` による疑似要素 `content: "\f111"` のCSS注入は維持
  - [ ] `dashicons` 読み込み（管理/フロント）は維持

- [ ] 動作確認（実装後）
  - [ ] 連結された `debug.log`（タイムスタンプが連続し改行なし）を用意し、表示が期待どおりに行分割されること
  - [ ] 秒が異なるログ（例: `...06:33:02` と `...06:33:04`）が別行になること
  - [ ] 強制キャプチャーON環境で連続エラーを発生させ、収集ファイル末尾が常に改行で終わること
  - [ ] 既存のUI/セキュリティ（権限・CSRF・パス検証）が影響を受けていないこと

- [ ] テスト・品質（TDDなし／既存テストに準拠）
  - [ ] `npm run test-all` を実行し、既存テストが緑であることを確認
  - [ ] もし管理バータイトルに `dashicons-...` を期待する既存テストがある場合は、仕様変更に合わせて期待値を更新（`<span>` を前提にしない）


---

## コミットコメント
feat: ログ分割強化（連結解消）と管理バーアイコンの純CSS化＋Phase7仕様の整備一式

■ 追加作業２（収集/表示の両面でログ連結を解消）
- collect: `ldl_format_captured_error()` の戻り値末尾に必ず改行を付与（二重改行は回避）し、連続書き込み時の連結を防止
- view: `ldl_read_log_file()` を「任意位置の `[DD-MMM-YYYY HH:MM:SS UTC]` タイムスタンプ境界で分割」する実装に変更
  - 既存の連結済みログも `[... UTC]` ごとに正しく分割
  - 多行（スタックトレース等）は1エントリとして保持
  - タイムスタンプ未検出時は改行分割にフォールバック
  - CRLF正規化と O(n) 一回走査で性能維持

■ 管理バーアイコン表示の安定化（純CSS化）
- `ldl_add_admin_bar_link()` の `title` から `<span class="dashicons ...">` を削除し、ラベルのみを表示
- `ldl_enqueue_adminbar_icon_style()` で `#wpadminbar #wp-admin-bar-ldl-admin-bar-link > .ab-item:before { content: "\f111"; }` を注入
- `dashicons` の読み込みは管理/フロント双方で維持

■ Phase 7 既存仕様の整備（前回分の確定）
- メニュー: 「ツール」配下へ移動（`add_management_page`。未定義環境では `add_options_page` にフォールバック）
- 管理バーリンク先: `tools.php?page=localize-debug-log` に変更
- 表示順トグル: 既定 `desc`（新→古）時は表示配列を反転するように修正
- 設定UI: テスト環境向けに `wp_nonce_field()/checked()` が無い場合のフォールバックを追加

■ ドキュメント
- README: Phase 7 機能（強制キャプチャー/表示順/ツール配下/アイコン安定化）を追記
- TechSpec: メニュー位置、ログ分割仕様、UI/管理バー仕様、Phase 7 関数一覧を更新

■ テスト
- `dev/tests/archive/2025-08-07_admin_menu_Test.php`: 仕様変更に合わせて「タイトルにアイコンclassを含む」期待を「ラベル文字列を含む」に更新
- 全テスト緑（Skipped含む）: Tests 138, Assertions 545, Skipped 9
