# Phase 5 追加作業: セキュリティ修正とDeprecation解消 — 要件定義

## 要件定義
- **概要説明**
  フェーズ5の追加作業として、セキュリティ上の致命的バグ（`ldl_validate_log_path` のディレクトリトラバーサル検知での無限ループ）と非推奨警告（`str_replace()`/`preg_match()` の null 引数）を解消し、該当テストを復活させたうえで全テストをグリーンにする。既存公開APIやUIは変更しない。

- **現在地**
  - フェーズ5のテスト実装は完了（Tests: 46, Assertions: 143, Skipped: 4, 全て成功）。
  - 課題:
    1) `ldl_validate_log_path` の `../` 処理で300秒タイムアウト発生
    2) `str_replace()`/`preg_match()` に null が渡る Deprecation 警告（`localize-debug-log.php` line 607, 210）
  - 一部テストは安全のためスキップ/代替検証に切替済み（要復活）。

- **ゴール（測定可能な到達点）**
  1) `ldl_validate_log_path` の無限ループを解消し、ディレクトリトラバーサル拒否テストを復活させて成功させる
  2) Deprecation 警告をゼロにする（`npm run test` 実行時に warning 非表示）
  3) すべてのテストが `npm run test` でグリーン、Skipped 0〜最小化（セキュリティ関連は復活必須）
  4) 実行時間は従来同等（~1秒未満目安）、タイムアウト無し

- **方針**
  - 変更範囲は「不具合修正と入力バリデーション強化」に限定（機能追加・UI変更・依存追加は行わない）
  - 既存API（`ldl_` 関数群）・引数・戻り値は維持
  - WP_Mock による単体テストをTDD的に追加（Red→Green→Refactor）
  - Windows/UNIX パス差異を吸収する正規化戦略を採用（区切り統一・`realpath` 基準・ベースディレクトリ境界判定）

- **作業対象ファイルの構造可視化**
```text
localize-debug-log/
  localize-debug-log.php        # 対象: パス検証・Deprecation 修正
dev/tests/active/
  2025-08-09_security_boundary_Test.php   # 復活・強化
  2025-08-09_error_handling_Test.php      # 必要に応じて追補
```

- **実装方針**
  - パス検証（`ldl_validate_log_path`）
    - 入力が null/空/非文字列の場合は即座に拒否
    - ベースディレクトリ（`plugin_dir_path(__FILE__).'logs'`）を取得し、`realpath` により正規化した上で「ベース配下に包含されているか」を判定
    - `realpath` が失敗する場合は、手動正規化ループを廃止し、安全側で拒否
    - Windows の区切りを `/` に統一して比較
  - Deprecation 対応
    - `str_replace`/`preg_match` の subject に null が渡らないよう、前段で型チェック・デフォルト空文字へのフォールバック or ガードリターン
  - テスト
    - WP_Mock で `plugin_dir_path` をモックし、ベースログディレクトリを安定的に再現
    - 「正常（ベース配下）」「`../` 含む」「絶対パス」「空/NULL」などのパス境界テストを復活・拡充
    - 既存E2E相当テストは維持（動作退行が無いことを確認）

- **絶対変更禁止項目**
  1) `_doc/_TechSpec.md` のバージョン要件・API仕様
  2) 公開関数名・引数シグネチャ（`ldl_` プレフィックス）
  3) UI（レイアウト／配色／文言）
  4) Composer/NPM の依存追加・変更

- **成功条件**
  - `npm run test` 実行で全テスト成功、セキュリティ関連テスト復活済み
  - Deprecation 警告が 0
  - タイムアウト（300秒）発生なし、処理時間は従来同等
  - Windows/PowerShell 環境での再現性確保（追加設定不要）

---

## チェックボックス付き実装計画書

**実装計画立案ルール**
- 詳細なステップバイステップの計画書
- とにかく小さい単位
- 明確な開始と終了がある
- １つの関心事に集中

## 計画書

### 🔍 0. 事前準備（TDD体制）
- [ ] `npm run test` が高速で通ることを再確認（PowerShell対応）
- [ ] `dev/tests/active/2025-08-09_security_boundary_Test.php` を編集可能状態にする
- [ ] 一時ログ環境用ヘルパ（テスト内生成・削除）を確認
- [ ] `plugin_dir_path()` を WP_Mock でモック可能にする前提を整理

---

### 🛡️ 機能A: パス検証の無限ループ解消（ldl_validate_log_path）

目的: ディレクトリトラバーサル（`../`）・絶対パス・空/NULL を安全に拒否し、ベース配下（`<plugin>/logs/…`）のみ許可する。

1) Red（ガード系: 空/NULL/非文字列の拒否）
- [ ] テスト追加（security_boundary_Test）
  - [ ] `ldl_validate_log_path('') === false`
  - [ ] `ldl_validate_log_path(null) === false`
  - [ ] `ldl_validate_log_path([]) === false`
- [ ] 実行: 失敗（または一部未実装）を確認

2) Green（ガード実装）
- [ ] `localize-debug-log.php` 内 `ldl_validate_log_path` の冒頭に型・空判定を追加（非文字列/空は即 false）
- [ ] 実行: ガード系テストが通ること

3) Red（正常系: ベース配下許可）
- [ ] テスト追加（security_boundary_Test）
  - [ ] `plugin_dir_path(__FILE__)` を WP_Mock でモックして、`<tmp>/plugin/` を返す
  - [ ] `<tmp>/plugin/logs/debug.log` を事前作成し、`ldl_validate_log_path` が true を返すこと
- [ ] 実行: 失敗を確認

4) Green（正常系実装）
- [ ] `realpath` により対象パスを正規化し、`<plugin>/logs` 配下への包含チェックを実装
- [ ] パス区切りは `/` に統一して比較
- [ ] 実行: 正常系テストがグリーン

5) Red（異常系: ディレクトリトラバーサル/絶対パス拒否）
- [ ] テスト復活＋強化（security_boundary_Test）
  - [ ] `<tmp>/plugin/logs/../etc/passwd` → false（`realpath` が logs 外を指す）
  - [ ] Windows 絶対パス例 `C:\\Windows\\System32\\config\\sam` → false
  - [ ] UNIX 絶対パス例 `/etc/passwd` → false
- [ ] 実行: 失敗を確認

6) Green（異常系実装）
- [ ] `realpath` が失敗（null/false）の場合は即 false
- [ ] `realpath` 成功時は `<plugin>/logs/` で始まるか厳密判定
- [ ] 実行: 全テストグリーン（タイムアウトなし）

7) Refactor
- [ ] パス正規化ロジックの私有関数化（テスト影響なし範囲）
- [ ] 可読性/境界チェックの明確化（早期 return）

---

### 🧽 機能B: Deprecation 解消（str_replace/preg_match に null 渡し）

目的: `localize-debug-log.php` line 607, 210 の null subject を根絶し、テスト時の Warning をゼロにする。

1) Red
- [ ] テスト追加（error_handling_Test）
  - [ ] 該当関数を null/空入力で呼び、戻り値が安全（空文字 or false）になることを期待
  - ※ Warning/Deprecated を直接アサートしない（挙動のみ検証）
- [ ] 実行: 失敗を確認

2) Green
- [ ] line 607/210 付近で subject の null ガードを追加（型チェック、空文字フォールバック or 早期 return）
- [ ] 実行: テスト成功、コンソール Warning が消えることを目視確認

3) Refactor
- [ ] 重複ガードの共通化（小関数化）※公開APIやUIに影響しない範囲

---

### 🔁 機能C: テスト復活と整理
- [ ] `2025-08-09_security_boundary_Test.php` のトラバーサル拒否テストを復活（WP_Mock で `plugin_dir_path` を安定化）
- [ ] 代替検証にしていた箇所は、本実装の挙動で置換（不要なスキップ/代替は削除）
- [ ] 実行: `npm run test` 全件グリーン、Skipped 最小化

---

### ✅ 完了判定
- [ ] Tests: 46+（増加可）、全グリーン、Skipped 0〜最小化
- [ ] `npm run test` 実行で Warning/Deprecated が 0
- [ ] 実行時間 ~1秒未満、タイムアウト無し
- [ ] ドキュメント（本ファイル・スコープ計画）更新

---

### 📦 コミット運用（Conventional Commits）
- [ ] fix(security): ldl_validate_log_path ディレクトリトラバーサル検知の無限ループ解消 + パス検証強化
- [ ] fix(core): null subject による deprecation を解消（str_replace/preg_match ガード追加）
- [ ] test(security): パス検証ユニットテスト復活＆強化、WP_Mock による plugin_dir_path 安定化
- [ ] docs(plan): フェーズ5追加作業のTDD計画・完了報告を更新

## コミットコメント
{{実装チェックリストが完了後、ユーザーの明確な承認を得たあとでチャットに出力されたコミットコメントを記載}}
