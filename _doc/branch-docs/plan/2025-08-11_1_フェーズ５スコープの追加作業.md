# Phase 5 追加作業: セキュリティ修正とDeprecation解消 — 要件定義

## 要件定義
- **概要説明**
  フェーズ5の追加作業として、セキュリティ上の致命的バグ（`ldl_validate_log_path` のディレクトリトラバーサル検知での無限ループ）と非推奨警告（`str_replace()`/`preg_match()` の null 引数）を解消し、元フェーズ5スコープの「PRIORITY 1-3」を完了してフェーズ5を完全終了させる。MVPに必要な重要テストのみ復活し、Nice-to-haveテストは明確にキャンセルする。既存公開APIやUIは変更しない。

- **現在地**
  - フェーズ5のテスト実装は完了（Tests: 46, Assertions: 143, Skipped: 4, 全て成功）。
  - 課題:
    1) **PRIORITY 1**: `ldl_validate_log_path` の `../` 処理で300秒タイムアウト発生（セキュリティ致命的）
    2) **Deprecation警告**: `str_replace()`/`preg_match()` に null が渡る警告（`localize-debug-log.php` line 607, 210）
    3) **PRIORITY 2**: グローバル変数操作系テストの代替検証不十分（POST処理・権限・nonce詳細）
    4) **PRIORITY 3**: ファイル操作系テストの代替検証不十分（実削除・権限エラー挙動）
  - 一部テストは安全のためスキップ/代替検証に切替済み。

- **ゴール（測定可能な到達点）**
  1) **PRIORITY 1完了**: `ldl_validate_log_path` の無限ループを解消し、ディレクトリトラバーサル拒否テストを復活させて成功
  2) **Deprecation解消**: 警告をゼロにする（`npm run test` 実行時に warning 非表示）
  3) **PRIORITY 2完了**: グローバル変数操作系の統合テスト強化（POST・権限・nonce詳細検証）
  4) **PRIORITY 3完了**: ファイル操作系の実体験証（実削除・権限エラー挙動確認）
  5) **テスト結果**: Tests: 46+, 全グリーン, Skipped: 1-3（明確にキャンセルするNice-to-haveテスト）
  6) **性能**: 実行時間は従来同等（~1秒未満目安）、タイムアウト無し

- **方針**
  - **MVP原則**: セキュリティ致命的バグ（PRIORITY 1）は必須修正、その他重要課題（PRIORITY 2-3）も完了してフェーズ5を完全終了
  - **明確なキャンセル**: Nice-to-haveテスト3つ（絶対パス拒否・CSRF異常系・削除エラー詳細）は明確にキャンセル、スキップ維持
  - 変更範囲は「不具合修正と入力バリデーション強化」に限定（機能追加・UI変更・依存追加は行わない）
  - 既存API（`ldl_` 関数群）・引数・戻り値は維持
  - WP_Mock による単体テストをTDD的に追加（Red→Green→Refactor）
  - Windows/UNIX パス差異を吸収する正規化戦略を採用（区切り統一・`realpath` 基準・ベースディレクトリ境界判定）

- **作業対象ファイルの構造可視化**
```text
localize-debug-log/
  localize-debug-log.php        # 対象: パス検証・Deprecation 修正
dev/tests/active/
  2025-08-09_security_boundary_Test.php   # PRIORITY 1対応: 復活・強化
  2025-08-09_e2e_log_ui_Test.php          # PRIORITY 2-3対応: 統合テスト強化
  2025-08-09_error_handling_Test.php      # Deprecation・エラー処理強化
```

- **明確にキャンセルするテスト（スキップ維持）**
```text
キャンセル理由: MVP観点でNice-to-have、コアセキュリティに致命的影響なし
1. ldl_validate_log_path_rejects_absolute_paths (絶対パス拒否)
2. ldl_csrf_protect_verify_mode_returns_false_on_invalid (CSRF異常系)
3. ldl_delete_log_file_returns_validate_error_on_invalid_path (削除エラー詳細)
```

- **実装方針**
  - パス検証（`ldl_validate_log_path`）
    - 入力が null/空/非文字列の場合は即座に拒否
    - ベースディレクトリ（`plugin_dir_path(__FILE__).'logs'`）を取得し、`realpath` により正規化した上で「ベース配下に包含されているか」を判定
    - `realpath` が失敗する場合は、手動正規化ループを廃止し、安全側で拒否
    - Windows の区切りを `/` に統一して比較
  - Deprecation 対応
    - `str_replace`/`preg_match` の subject に null が渡らないよう、前段で型チェック・デフォルト空文字へのフォールバック or ガードリターン
  - テスト
    - WP_Mock で `plugin_dir_path` をモックし、ベースログディレクトリを安定的に再現
    - 「正常（ベース配下）」「`../` 含む」「絶対パス」「空/NULL」などのパス境界テストを復活・拡充
    - 既存E2E相当テストは維持（動作退行が無いことを確認）

- **絶対変更禁止項目**
  1) `_doc/_TechSpec.md` のバージョン要件・API仕様
  2) 公開関数名・引数シグネチャ（`ldl_` プレフィックス）
  3) UI（レイアウト／配色／文言）
  4) Composer/NPM の依存追加・変更

- **成功条件**
  - **元フェーズ5スコープの完全完了**: PRIORITY 1-3の全項目対応済み
  - **テスト結果**: `npm run test` で Tests: 46+, 全グリーン, Skipped: 1-3（キャンセル済みNice-to-have）
  - **セキュリティ**: ディレクトリトラバーサル拒否テスト復活・成功
  - **品質向上**: Deprecation 警告が 0
  - **性能**: タイムアウト（300秒）発生なし、処理時間は従来同等
  - **環境**: Windows/PowerShell 環境での再現性確保（追加設定不要）

---

## チェックボックス付き実装計画書

**実装計画立案ルール**
- 詳細なステップバイステップの計画書
- とにかく小さい単位
- 明確な開始と終了がある
- １つの関心事に集中

## 計画書

### 🔍 0. 事前準備（TDD体制）
- [ ] `npm run test` が高速で通ることを再確認（PowerShell対応）
- [ ] `dev/tests/active/2025-08-09_security_boundary_Test.php` を編集可能状態にする
- [ ] 一時ログ環境用ヘルパ（テスト内生成・削除）を確認
- [ ] `plugin_dir_path()` を WP_Mock でモック可能にする前提を整理

---

### 🛡️ 機能A: パス検証の無限ループ解消（ldl_validate_log_path）

目的: ディレクトリトラバーサル（`../`）・絶対パス・空/NULL を安全に拒否し、ベース配下（`<plugin>/logs/…`）のみ許可する。

1) Red（ガード系: 空/NULL/非文字列の拒否）
- [ ] テスト追加（security_boundary_Test）
  - [ ] `ldl_validate_log_path('') === false`
  - [ ] `ldl_validate_log_path(null) === false`
  - [ ] `ldl_validate_log_path([]) === false`
- [ ] 実行: 失敗（または一部未実装）を確認

2) Green（ガード実装）
- [ ] `localize-debug-log.php` 内 `ldl_validate_log_path` の冒頭に型・空判定を追加（非文字列/空は即 false）
- [ ] 実行: ガード系テストが通ること

3) Red（正常系: ベース配下許可）
- [ ] テスト追加（security_boundary_Test）
  - [ ] `plugin_dir_path(__FILE__)` を WP_Mock でモックして、`<tmp>/plugin/` を返す
  - [ ] `<tmp>/plugin/logs/debug.log` を事前作成し、`ldl_validate_log_path` が true を返すこと
- [ ] 実行: 失敗を確認

4) Green（正常系実装）
- [ ] `realpath` により対象パスを正規化し、`<plugin>/logs` 配下への包含チェックを実装
- [ ] パス区切りは `/` に統一して比較
- [ ] 実行: 正常系テストがグリーン

5) Red（異常系: ディレクトリトラバーサル/絶対パス拒否）
- [ ] テスト復活＋強化（security_boundary_Test）
  - [ ] `<tmp>/plugin/logs/../etc/passwd` → false（`realpath` が logs 外を指す）
  - [ ] Windows 絶対パス例 `C:\\Windows\\System32\\config\\sam` → false
  - [ ] UNIX 絶対パス例 `/etc/passwd` → false
- [ ] 実行: 失敗を確認

6) Green（異常系実装）
- [ ] `realpath` が失敗（null/false）の場合は即 false
- [ ] `realpath` 成功時は `<plugin>/logs/` で始まるか厳密判定
- [ ] 実行: 全テストグリーン（タイムアウトなし）

7) Refactor
- [ ] パス正規化ロジックの私有関数化（テスト影響なし範囲）
- [ ] 可読性/境界チェックの明確化（早期 return）

---

### 🧽 機能B: Deprecation 解消（str_replace/preg_match に null 渡し）

目的: `localize-debug-log.php` line 607, 210 の null subject を根絶し、テスト時の Warning をゼロにする。

1) Red
- [ ] テスト追加（error_handling_Test）
  - [ ] 該当関数を null/空入力で呼び、戻り値が安全（空文字 or false）になることを期待
  - ※ Warning/Deprecated を直接アサートしない（挙動のみ検証）
- [ ] 実行: 失敗を確認

2) Green
- [ ] line 607/210 付近で subject の null ガードを追加（型チェック、空文字フォールバック or 早期 return）
- [ ] 実行: テスト成功、コンソール Warning が消えることを目視確認

3) Refactor
- [ ] 重複ガードの共通化（小関数化）※公開APIやUIに影響しない範囲

---

### 🔁 機能C: PRIORITY 1テスト復活（セキュリティ致命的）
- [ ] `2025-08-09_security_boundary_Test.php` のトラバーサル拒否テストを復活（WP_Mock で `plugin_dir_path` を安定化）
- [ ] `markTestSkipped` の無限ループテストを本実装で置換
- [ ] 実行: セキュリティ重要テストが成功

---

### 🎯 機能D: PRIORITY 2対応（グローバル変数操作系の統合テスト強化）

目的: `ldl_handle_delete_request` の POST処理・権限チェック・nonce検証の詳細な統合テストを強化

1) 現状分析と強化ポイント特定
- [ ] `2025-08-09_e2e_log_ui_Test.php` の `deletion_request_flow_integration_test` を確認
- [ ] 不十分な検証項目を特定（POST限定・管理者権限・nonce詳細・エラー分類）
- [ ] 強化方針決定

2) Red（統合フロー詳細検証）
- [ ] テスト追加・強化（e2e_log_ui_Test）
  - [ ] GET リクエスト時は無視される挙動
  - [ ] 非管理者ユーザー時は `permission` エラー
  - [ ] nonce 不一致時は `nonce` エラー
  - [ ] パス検証失敗時は `validate` エラー
  - [ ] 正常時は `success=true` とファイル処理実行
- [ ] 実行: 失敗（詳細検証不十分）を確認

3) Green（統合テスト実装）
- [ ] WP_Mock で `current_user_can`, `check_admin_referer`, `$_POST` を適切にモック
- [ ] 各エラー分岐の挙動を詳細に検証する統合テスト実装
- [ ] 実行: 統合フローテストが全てグリーン

---

### 🗂️ 機能E: PRIORITY 3対応（ファイル操作系の実体験証）

目的: `ldl_delete_log_file` の実ファイル削除・再生成・権限エラー時の挙動確認

1) 現状分析と実体験証方針
- [ ] 既存のファイル操作テストの代替検証状況を確認
- [ ] 実ファイル操作が必要な検証項目を特定（削除後再生成・権限エラー・サイズ確認）
- [ ] 安全な一時ファイル環境での実体験証設計

2) Red（実ファイル操作検証）
- [ ] テスト追加（error_handling_Test または新規）
  - [ ] 一時ログファイル作成→削除→サイズ0ファイル再生成の一連フロー
  - [ ] 権限なしディレクトリでの削除失敗時の安定挙動
  - [ ] ファイル削除とログ出力の整合性確認
- [ ] 実行: 失敗（実体験証不十分）を確認

3) Green（実ファイル操作実装）
- [ ] 一時ディレクトリでの安全なファイル操作テスト実装
- [ ] ファイル削除・再生成の実際の挙動検証
- [ ] 実行: ファイル操作の実体験証テストが成功

---

### 🚫 機能F: Nice-to-haveテストの明確なキャンセル処理
- [ ] 以下3テストのスキップ理由を「MVP完了のため意図的にキャンセル」に更新
  - [ ] `ldl_validate_log_path_rejects_absolute_paths` → 「MVP: 絶対パス攻撃は限定的影響」
  - [ ] `ldl_csrf_protect_verify_mode_returns_false_on_invalid` → 「MVP: CSRF正常系は動作済み」
  - [ ] `ldl_delete_log_file_returns_validate_error_on_invalid_path` → 「MVP: 削除正常系は動作済み」
- [ ] コメントに「Phase 6以降で対応検討」を明記

---

### ✅ 完了判定
- [ ] **元フェーズ5完全完了**: PRIORITY 1-3の全対応完了、フェーズ5スコープ終了
- [ ] **テスト結果**: Tests: 46+（増加）、全グリーン、Skipped: 1-3（意図的キャンセル）
- [ ] **セキュリティ**: ディレクトリトラバーサル無限ループ解消、テスト復活成功
- [ ] **統合テスト**: POST・権限・nonce・ファイル操作の詳細検証完了
- [ ] **品質**: `npm run test` 実行で Warning/Deprecated が 0
- [ ] **性能**: 実行時間 ~1秒未満、タイムアウト無し
- [ ] **ドキュメント**: 本ファイル・元スコープ計画の完了更新

---

### 📦 コミット運用（Conventional Commits）
- [ ] fix(security): ldl_validate_log_path ディレクトリトラバーサル検知の無限ループ解消 + パス検証強化
- [ ] fix(core): null subject による deprecation を解消（str_replace/preg_match ガード追加）
- [ ] test(security): パス検証ユニットテスト復活＆強化、WP_Mock による plugin_dir_path 安定化
- [ ] test(integration): POST・権限・nonce・ファイル操作の統合テスト強化（PRIORITY 2-3対応）
- [ ] test(skip): Nice-to-haveテスト3つを明確にキャンセル、MVP完了を優先
- [ ] docs(plan): フェーズ5完全完了、元スコープの全PRIORITY項目対応完了を更新
- [ ] feat(phase5): フェーズ5: テスト実装・品質保証 - 完全完了

## コミットコメント
{{実装チェックリストが完了後、ユーザーの明確な承認を得たあとでチャットに出力されたコミットコメントを記載}}
