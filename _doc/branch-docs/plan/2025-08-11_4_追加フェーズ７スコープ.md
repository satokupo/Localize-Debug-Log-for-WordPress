# Phase 7: 収集強化・UI拡張 — 要件定義（追加フェーズ）

## 要件定義

- 概要説明: WordPress コアや既存のデバッグ設定を変更せずに、プラグイン単体でログ収集力を最大化する「強制キャプチャーモード」をオプトインで提供し、UX改善（管理バーアイコン修正・フロントでも管理バーに表示・ログ表示順のトグル）を行う。
- 現在地: Phase 6（最終化・リリース準備）は完了。MVPは完成。追加要望により Phase 7 を設定。
- ゴール:
  - WP_DEBUG=false の環境でも可能な限りログを収集（強制キャプチャーON時）
  - 管理バーのアイコンを dashicons の歯車に統一し文字化けを解消
  - フロント側でも（ログイン中で権限があれば）管理バーに「Localize Debug Log」を表示
  - ログ表示順（新しい→古い／古い→新しい）を切り替えるトグルを提供
- 方針:
  - 強制キャプチャーは「オプトイン（デフォルトOFF）」で UI トグルにより切替可能。
  - コア・定数（WP_DEBUG 等）を上書きしない。PHP ランタイム設定とカスタムハンドラでカバー。
  - 既存ハンドラがある場合はチェーン（委譲）し、他プラグインへの影響を最小化。
  - 既存UI/公開APIの互換は維持（追加UIは既存画面の上部に最小限で配置）。
  - ログ収集先・セキュリティ（CSRF/権限/パス検証）は従来仕様を維持。

### 作業対象ファイルの構造可視化 (抜粋)
```
localize-debug-log/
 └─ localize-debug-log.php   # 本体（単一ファイル構成）
```

### 実装方針（高レベル）
- 強制キャプチャーモード（オプトイン）
  - UI: ログ表示テキストエリアの直上にトグルを配置（ON/OFF）。横に説明文（機能概要/効果/注意点）を表示。
  - ストレージ: `get_option('ldl_force_capture')`（boolean）で保持。nonce 付きPOSTで更新。
  - 有効時の動作:
    - `ini_set('log_errors','1')`, `ini_set('error_log', ldl_get_log_path())`（パス誘導の強化）
    - `set_error_handler` で E_WARNING/E_NOTICE/E_DEPRECATED などを補足しファイル直書き（第3引数）
    - `set_exception_handler` で未捕捉例外を記録
    - `register_shutdown_function` で致命的エラーを `error_get_last()` から記録
    - 既存ハンドラがある場合は、処理後に必ず委譲（チェーン）
  - 既定値: OFF（互換維持）。
  - 追加オプション（検討）: `LDL_FORCE_REPORTING` 定数が true のときのみ `error_reporting(E_ALL)` に引上げ。

- 管理バーの改善
  - アイコン: dashicons-admin-generic（歯車）を使用し文字化け解消。
  - 表示範囲: 管理画面だけでなくフロントでも表示（`admin_bar_menu` はフロントでも発火、権限チェックは維持）。
  - 権限: `current_user_can('manage_options')` のみ表示（従来通り）。

- ログ表示順トグル
  - UI: テキストエリア上部に「表示順トグル（新しい→古い｜古い→新しい）」を配置（強制キャプチャートグルと同ブロックに並置）。
  - ストレージ: `get_option('ldl_log_order')`（'desc'|'asc'）。初期値 'desc'（最新が上）。
  - 実装: フォーマット済み配列に対して UI の選択に応じて `array_reverse()` 等で並び替え（表示のみ。収集ストレージは不変）。
  - 反映: nonce 付きPOSTで即時反映、画面再描画で順序が変わる。

### 絶対変更禁止項目
- WPコア・定数の上書き（WP_DEBUG 等）はしない。
- 既存の関数シグネチャ・返り値の意味論を破壊しない。
- 既存のセキュリティ要件（権限/CSRF/パス検証）を緩めない。
- 既定挙動（トグルOFF時）は Phase 6 時点と同等。

### 成功条件（検証可能な基準）
- 強制キャプチャーONで、WP_DEBUG=false でもテーマ/プラグイン由来の警告・注意などが `logs/debug.log` に記録される。
- 既存ハンドラ/他プラグインと併用しても致命的な衝突が発生しない（既存ハンドラへの委譲を実装）。
- 管理バー:
  - 歯車アイコンが管理画面/フロント双方で正常表示
  - ログイン中かつ権限保持ユーザにのみ表示
- ログ表示順トグル:
  - UI操作で表示順が即時切替
  - XSS対策（エスケープ）・UI構造不変、CSRF対策あり
- 既存テスト資産は緑を維持し、追加テストで新機能を担保。

---

## チェックボックス付き実装計画書（要件承認後に着手）

**実装計画立案ルール**
- 小さく安全に、Red→Green→Refactor（必要最小テスト）
- 公開API不変、挙動の既定値不変

## 計画書（TDD・機能単位）

- 準備
  - [ ] ブランチ作成 `feature/phase7-force-capture-and-ui`
  - [ ] 影響範囲の固定（関数/フック/option名）を本計画へ反映

- 強制キャプチャーモード（オプトイン・既定OFF）
  - 仕様要点: option `ldl_force_capture` (bool, default=false)、UIトグル、説明文、nonce付与、保存。ON時のみハンドラ登録・ini適用。既存ハンドラへ委譲（チェーン）。
  - Red（ストレージ/UI）
    - [ ] テスト: `ldl_render_log_page` にトグルUIと説明文が表示される（権限者/nonce）
    - [ ] テスト: POSTで `ldl_force_capture` が保存される（true/false、サニタイズ）
  - Green（ストレージ/UI）
    - [ ] 実装: option 読み書きユーティリティ `ldl_get_option_bool($key,$default)`（内部関数）
    - [ ] 実装: UIトグル（textarea直上）＋説明文（効果/注意/推奨）＋nonce + 保存処理
  - Red（動作）
    - [ ] テスト: `ldl_force_capture`=true の時だけ、エラー擬似（E_USER_WARNING 等）でログファイルが増加する
    - [ ] テスト: 例外/致命的エラー疑似時にログが追記される（shutdown/exception経由）
    - [ ] テスト: 既存エラーハンドラが存在する場合も呼び出される（委譲）
  - Green（動作）
    - [ ] 実装: `ldl_register_force_capture_handlers()`（ON時のみ実行）
      - `ini_set('log_errors','1')`、`ini_set('error_log', ldl_get_log_path())`
      - `set_error_handler('ldl_force_error_handler')`（委譲対応）
      - `set_exception_handler('ldl_force_exception_handler')`（委譲対応）
      - `register_shutdown_function('ldl_force_shutdown_handler')`
    - [ ] 実装: `ldl_force_error_handler`/`ldl_force_exception_handler`/`ldl_force_shutdown_handler`
      - `error_log($msg, 3, ldl_get_log_path())` 直書き、必要な情報（時刻/種別/ファイル/行）整形
      - 既存ハンドラが取得できる場合は委譲呼び出し
  - Refactor
    - [ ] ログ整形の共通化 `ldl_format_captured_error($context)`（内部関数）
    - [ ] パフォーマンス/多重記録の過剰防止（無限ループ回避・再帰ガード）

- 管理バー改善（歯車アイコン/フロントでも表示）
  - 仕様要点: 権限者のみ、管理画面/フロント両方で表示。dashicons-admin-generic を正しく表示（文字化け解消）。
  - Red
    - [ ] テスト: `admin_bar_menu` がフロントでも権限者に対し実行され、ノードが出現
    - [ ] テスト: アイコンHTMLが dashicons-admin-generic でレンダリングされる
  - Green
    - [ ] 実装: `ldl_register_admin_ui()` の登録範囲見直し（フロントでも `admin_bar_menu` 登録）
    - [ ] 実装: dashicons の読み込みをフロントでも確保（必要に応じ `wp_enqueue_scripts`/`admin_enqueue_scripts`）
  - Refactor
    - [ ] タイトル/クラス/ID の定数化（意図の明確化）

- ログ表示順トグル（asc/desc）
  - 仕様要点: option `ldl_log_order` ('desc'|'asc', default='desc')。UIトグル（既存トグル群の横）で切替、nonce保存。表示のみ並替。
  - Red
    - [ ] テスト: 既定は 'desc'（最新が上）で表示される
    - [ ] テスト: 'asc' を選択すると、HTML構造不変のまま行順が反転
    - [ ] テスト: POSTで `ldl_log_order` が保存/反映される
  - Green
    - [ ] 実装: `ldl_render_log_page` で option に応じて `array_reverse()`（表示のみ）
    - [ ] 実装: UIトグル（asc/desc）＋nonce保存
  - Refactor
    - [ ] UIブロックのテンプレート化（エスケープ責務の明確化）

- ドキュメント/テスト/仕上げ
  - [ ] README/TechSpec 更新（強制キャプチャーモード、順序トグル、管理バー表示範囲）
  - [ ] テスト一式緑の確認（既存74 + 追加分）、警告ゼロ
  - [ ] 差分レビュー（公開API不変/セキュリティ担保/UI意図）

---

## コミットコメント
{{本フェーズの実装完了後に記載}}
