# Phase 3: 管理画面 UI 実装 — 要件定義 (MVP)

## 🎯 概要
シングルサイト運用を前提に、管理者がログを閲覧・削除できる最小 UI を実装する。
国際化・マルチサイト対応は後続フェーズで扱う。

## 関連関数（新規）
| 関数名 | 役割 |
|--------|------|
| ldl_add_admin_menu | 設定メニューにページ追加（admin_menuフックで入口制御） |
| ldl_add_admin_bar_link | 管理バーにログ画面リンクを追加 |
| ldl_render_log_page | textareaでログ表示（esc_textarea適用）＋削除ボタン出力 |
| ldl_handle_delete_request | 削除リクエスト受付・nonce検証・削除処理呼び出し |
| ldl_delete_log_file | ログファイル削除処理（unlink）＋空のdebug.log再生成 |
| ldl_notice_delete_result | 削除成功・失敗通知をadmin_noticesで出力 |

## 📍 現状
- Phase 2 コア 14 関数完了（変更禁止）
- 開発環境：PHPUnit + WP_Mock 構築済み

## ゴール（動作レベル）
1. 「設定 › Localize Debug Log」メニューと管理バーリンクから画面に遷移できる
2. textarea に `ldl_get_formatted_log()` の出力を `esc_textarea()` 適用で表示
3. textarea は読み取り専用でコピー可能な形式で出力される
4. 削除ボタン → JS confirm → POST → `ldl_handle_delete_request()` → `ldl_delete_log_file()` でログ削除
5. 削除後は空の `debug.log` ファイルが自動的に再生成される
6. 成功 / 失敗の結果は `ldl_notice_delete_result()` によって画面上に通知される
7. 管理者以外には画面が表示されず、メニューも表示されない（入口遮断により保護）

## 技術方針
- WordPress 標準 UI＋dashicons のみ使用（独自 CSS なし）
- 削除 POST のみ nonce (`wp_nonce_field` / `check_admin_referer`) 実装
- ログは読み取り専用。ファイル名・パスは `localize-debug-log/logs/debug.log` に固定

## 成功条件（検証可能）
- メニュー・管理バーから遷移し textarea が表示される
- ローカル時刻付きログがエスケープ済みで表示される
- 1 MB 超で警告メッセージ
- 削除成功で「ログファイルを削除しました」通知、失敗で理由付き通知
- nonce 不一致・権限不足時に処理拒否＋エラーメッセージ

## 実装チェックリスト
- [ ] ldl_add_admin_menu 実装・動作確認
- [ ] ldl_add_admin_bar_link 実装・動作確認
- [ ] ldl_render_log_page 実装（`esc_textarea`）
- [ ] ldl_handle_delete_request 実装（nonce & confirm）
- [ ] ldl_delete_log_file 実装（flock は Phase-4）
- [ ] ldl_notice_delete_result 実装
- [ ] PHPUnit: Ldl_Ui_Test 作成（表示／削除／警告）


---

## チェックボックス付き実装計画書

**実装計画立案ルール**
- 詳細なステップバイステップの計画書
- とにかく小さい単位
- 明確な開始と終了がある
- １つの関心事に集中

## 計画書

### 📋 Phase 3: 管理画面UI実装チェックリスト

**🧪 TDD適用判断**
- **重点TDD**: ログ削除機能・通知機能・セキュリティ部分
- **軽量テスト**: メニュー追加・表示機能（WordPress関数モック）
- **Phase 2基盤活用**: `ldl_get_formatted_log()` 等の既存14関数最大活用

#### 🔧 1. 開発環境準備・Phase 2基盤確認
- [ ] 開発環境の動作確認
  - [ ] `npm run test` でPHPUnitが正常実行されることを確認
  - [ ] Phase 2実装の14関数が全て利用可能であることを確認
  - [ ] WP_Mock環境でWordPress管理画面関数のモック準備
- [ ] Phase 3実装範囲の再確認
  - [ ] マイルストーンPhase 3項目の詳細確認（6関数+1テストクラス）
  - [ ] 技術仕様書フック・UI仕様の確認
  - [ ] dashicons-admin-settings使用方針確認

#### 🧪 2. テストファイル作成・テストケース設計

**WordPress管理画面UI テスト方針:**
- WP_Mock でWordPress管理画面関数（add_options_page等）をモック化
- ファイル操作・セキュリティ部分は実テンポラリファイル使用
- UI表示部分は出力バッファ（ob_start）でHTML確認
- **テスト重点**: セキュリティ機能・ファイル操作・Phase 2関数連携

- [ ] 管理画面メニューテストファイル作成
  - [ ] `dev/tests/active/2025-08-07_admin_menu_Test.php` 作成
  - [ ] 基本的なテストケース設計
    - [ ] `add_options_page()` 正常実行テストケース
    - [ ] `admin_bar_menu` フック登録テストケース
    - [ ] administrator権限チェックテストケース
    - [ ] dashicons-admin-settings 適用テストケース
- [ ] ログ表示画面テストファイル作成
  - [ ] `dev/tests/active/2025-08-07_log_display_Test.php` 作成
  - [ ] Phase 2関数連携テストケース設計
    - [ ] `ldl_get_formatted_log()` 呼び出しテストケース
    - [ ] HTML出力（textarea + esc_textarea）の基本テストケース
    - [ ] ログ未存在時の表示テストケース
    - [ ] 1MB超ファイルサイズ警告テストケース
- [ ] ログ削除機能テストファイル作成（TDD重点）
  - [ ] `dev/tests/active/2025-08-07_log_deletion_Test.php` 作成
  - [ ] セキュリティ重視テストケース設計
    - [ ] nonce検証テストケース
    - [ ] 権限チェックテストケース
    - [ ] ファイル削除処理テストケース
    - [ ] 空ファイル再生成処理テストケース
    - [ ] admin_notices通知テストケース

#### ✨ 3. コア関数実装：管理画面メニュー追加（軽量テスト）
- [ ] 管理画面メニュー関数の実装
  - [ ] `ldl_add_admin_menu()` 関数作成
    - [ ] テストを先に作成（Red段階）
    - [ ] `add_options_page()` による設定サブメニュー追加実装
    - [ ] dashicons-admin-settings アイコン指定実装
    - [ ] テスト合格確認（Green段階）
    - [ ] コードリファクタリング（Refactor段階）
  - [ ] `ldl_add_admin_bar_link()` 関数作成
    - [ ] `admin_bar_menu` フックでのリンク追加テスト作成
    - [ ] `$wp_admin_bar->add_node()` による管理バーメニュー実装
    - [ ] テスト合格・リファクタリング
  - [ ] 管理画面フック統合処理の実装
    - [ ] `admin_menu` (優先度10), `admin_bar_menu` (優先度100) フック登録
    - [ ] `is_admin()` チェックによる管理画面限定実行
    - [ ] テスト合格・リファクタリング
- [ ] 管理画面メニュー統合テスト実行
  - [ ] `npm run test` で作成したテストが全て合格することを確認
  - [ ] WordPress関数モックが正常動作することを確認

#### 🖥️ 4. コア関数実装：ログ表示画面（Phase 2基盤活用）
- [ ] ログ表示画面関数の実装
  - [ ] `ldl_render_log_page()` 関数作成
    - [ ] HTML出力の基本テスト作成（textarea + esc_textarea確認）
    - [ ] Phase 2の`ldl_get_formatted_log()`関数呼び出し実装
    - [ ] WordPress標準クラス（.widefat）使用の実装
    - [ ] 1MBファイルサイズ警告機能実装
    - [ ] 削除ボタン・フォーム生成実装
    - [ ] テスト合格・リファクタリング
  - [ ] JavaScript確認プロンプト実装
    - [ ] `confirm()` による削除確認スクリプト追加
    - [ ] インライン JavaScript の安全な出力実装
- [ ] ページ表示統合処理の実装
  - [ ] 権限チェック（`current_user_can('administrator')`）実装
  - [ ] ログファイル存在チェック・適切なメッセージ表示
  - [ ] Phase 2関数との連携確認テスト
- [ ] ログ表示画面統合テスト実行
  - [ ] 全テストケース合格確認
  - [ ] Phase 2関数との連携が正常動作することを確認

#### 🗑️ 5. コア関数実装：ログ削除機能（TDD重点）
- [ ] ログ削除リクエスト処理関数の実装
  - [ ] `ldl_handle_delete_request()` 関数作成
    - [ ] nonce検証の基本テスト作成
    - [ ] `check_admin_referer()` による検証実装
    - [ ] administrator権限チェック実装
    - [ ] POST処理・リダイレクト実装
    - [ ] テスト合格確認
  - [ ] `ldl_delete_log_file()` 関数作成（TDD重要）
    - [ ] ファイル削除処理のテスト作成
    - [ ] `unlink()` による削除実装
    - [ ] 削除後の空ファイル再生成処理実装（技術仕様書:20行準拠）
    - [ ] エラーハンドリング実装
    - [ ] テスト合格・リファクタリング
  - [ ] `ldl_notice_delete_result()` 関数作成（TDD）
    - [ ] admin_notices通知のテスト作成
    - [ ] 成功・失敗通知の分岐実装
    - [ ] WordPress標準通知スタイル使用実装
    - [ ] テスト合格・リファクタリング
- [ ] ログ削除機能統合テスト実行
  - [ ] セキュリティ機能（nonce・権限）の正常動作確認
  - [ ] ファイル削除・空ファイル再生成機能の正常動作確認
  - [ ] 通知機能の正常動作確認

#### 🔗 6. 管理画面UI統合・WordPress統合処理
- [ ] メインプラグインファイルの統合
  - [ ] `localize-debug-log.php` にPhase 3関数追加
  - [ ] 管理画面専用の初期化処理実装
  - [ ] `admin_init` フック（優先度10）でPOST処理実装
  - [ ] Phase 2基盤機能との共存確認
- [ ] WordPress管理画面との統合
  - [ ] フック登録の適切な優先度設定確認
  - [ ] 他プラグインとの競合回避確認
  - [ ] セッション・リダイレクト処理の実装
- [ ] 統合動作テストの実行
  - [ ] プラグイン有効化→管理画面アクセス→ログ表示→削除の一連テスト
  - [ ] administrator以外のアクセステスト（入口遮断確認）
  - [ ] Phase 2機能との同時動作確認

#### 🧪 7. PHPUnit UI テスト実装（class: Ldl_Ui_Test）
- [ ] UIテストクラス作成
  - [ ] `dev/tests/active/2025-08-07_ui_integration_Test.php` 作成
  - [ ] `class Ldl_Ui_Test` 実装
  - [ ] WordPress環境モックの統合設定
- [ ] 統合テストケース実装
  - [ ] 管理画面メニュー表示統合テスト
  - [ ] ログ表示画面の表示内容統合テスト
  - [ ] ログ削除機能の統合テスト（ファイル操作含む）
  - [ ] 権限チェック統合テスト
  - [ ] エラーハンドリング統合テスト

#### ✅ 8. 品質保証・最終確認
- [ ] コード品質チェック
  - [ ] 全関数に `ldl_` プレフィックスが付与されているか確認
  - [ ] WordPress管理画面標準クラス・dashiconsのみ使用確認
  - [ ] 独自CSS・外部ライブラリが使用されていないか確認
  - [ ] PHPDoc コメントの適切な記述確認
- [ ] 全テストスイート実行
  - [ ] `npm run test` でPhase 2・3全テストが合格することを確認
  - [ ] セキュリティ関連テスト（nonce・権限・ファイル操作）の実行確認
  - [ ] WordPress関数モックの正常動作確認
  - [ ] UIテストクラスの正常実行確認
- [ ] 機能動作確認（理論上確認）
  - [ ] 管理画面メニュー表示・アクセス確認
  - [ ] dashicons-admin-settingsアイコン表示確認
  - [ ] ログ表示画面の正常表示確認（1MB警告含む）
  - [ ] ログ削除機能の正常動作確認（空ファイル再生成含む）
  - [ ] 権限制御・セキュリティ機能確認
- [ ] Phase 3実装完了確認
  - [ ] マイルストーンPhase 3項目との完全照合確認
  - [ ] 技術仕様書UI要件との適合確認
  - [ ] 要件定義書管理画面仕様との適合確認
  - [ ] Phase 3完了の最終確認

---

## コミットコメント
{{実装チェックリストが完了後、ユーザーの明確な承認を得たあとでチャットに出力されたコミットコメントを記載}}
