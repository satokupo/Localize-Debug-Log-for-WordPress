# Phase 6: 最終化・リリース準備 — 要件定義

## 要件定義

- **概要説明**: 本フェーズは、機能追加や仕様拡張を行わず、既存実装の信頼性・保守性・整合性を高めてリリース可能状態に仕上げることを目的とする。対象はエラーハンドリングの強化、コード品質チェック、ドキュメント整合、最終動作確認に限定する。
- **現在地**: `_doc/_Milestone.md` 記載の Phase 1〜5 は完了。コア機能・UI・セキュリティ・テストは成立済みで、Phase 5で不具合と非推奨の解消・テスト拡充も実施済み。
- **ゴール**:
  - エラーハンドリングの強化（公開APIやUI挙動を変えずに、防御的ガードと失敗時の安全側動作を明確化）
  - コード品質チェックの完了（`ldl_` プレフィックス統一および WordPress コーディング規約準拠の確認）
  - ドキュメントの最終整合（技術仕様・構成・マイルストーン・readme の内容一貫性）
  - ステージング環境での最終動作確認の記録・受領
- **方針**:
  - 機能追加・仕様変更は原則禁止。公開APIシグネチャ、返り値、UI/UX、外部依存の挙動は不変とする。
  - 変更は「エラーパスの明確化」「入力検証の強化」「例外的状況での安全側フォールバック」などに限定。
  - コード変更は最小差分・高可読性・既存テスト資産との整合を最優先。
  - ドキュメントは技術仕様（`_doc/_TechSpec.md`）を正とし、差分は仕様側へ反映・整合させる。
- **スコープ（In/Out）**:
  - In: ガード追加、失敗時の戻り値の明確化、ログメッセージ整備（必要最小限）、命名・スタイル統一、ドキュメント整合、ステージング検証。
  - Out: 新規機能、UIレイアウト/スタイル変更、依存バージョン更新、DBや外部サービス連携の追加、APIシグネチャ変更。
- **作業対象ファイルの構造可視化 (抜粋)**:
  ```
  Localize Debug Log for WordPress/
  ├─ localize-debug-log/
  │  ├─ localize-debug-log.php
  │  ├─ logs/
  │  │  └─ debug.log
  │  └─ readme.md
  ├─ dev/
  │  ├─ composer.json
  │  ├─ phpunit.xml
  │  └─ tests/
  │     └─ active/ ...
  └─ _doc/
     ├─ _TechSpec.md
     ├─ _Structure.md
     ├─ _TestWorkflow.md
     └─ _Milestone.md
  ```
- **実装方針（高レベル）**:
  - エラーハンドリング: 非文字列/空入力/権限不足/ファイルI/O失敗などの入口で早期リターンを徹底し、既存の正常系を阻害しない。
  - コーディング規約: `ldl_` プレフィックスの例外検出・解消、PSR準拠よりも WP Coding Standards を優先（本プロジェクト方針に従う）。必要に応じて内部チェック関数（例: `ldl_run_coding_standards`）またはスクリプトを用意しても、ランタイム挙動は不変とする。
  - ドキュメント整合: 仕様（_TechSpec）、構成（_Structure）、マイルストーン（_Milestone）、readme の間で記述差異を解消し、用語と関数名を統一。
  - テスト: 既存テスト資産での網羅を維持しつつ、必要最小限の追加アサーションで回 regress を防止（新規大規模テストは追加しない）。
- **絶対変更禁止項目**:
  - 公開API/関数シグネチャ・返り値の意味論、UI/UX（レイアウト、色、フォント、間隔、要素構成）
  - 依存関係とバージョン（技術仕様書の記載を変更しない）
  - プラグイン識別子（ディレクトリ名、メインファイル名、テキストドメイン等）
  - ライセンス方針・文言
- **成功条件（検証可能な基準）**:
  - テスト: 全テストが成功し、非推奨警告/例外/無限ループがゼロであること。
  - コーディング規約: `ldl_` プレフィックスの不整合ゼロ、WP Coding Standards 違反ゼロ（または合意済みの例外のみ）。
  - ドキュメント: `_doc/_TechSpec.md`・`_doc/_Structure.md`・`_doc/_Milestone.md`・`localize-debug-log/readme.md` の整合が取れていること（機能説明・関数名・制約が一致）。
  - 挙動: UI表示・管理画面フック・ファイル操作のユーザー体験が Phase 5 時点と等価であること（差分なし）。
  - ステージング: 最終動作確認の結果報告が記録され、承認済みであること。
- **品質管理**:
  - 変更差分のレビュー観点: 公開API不変、UI不変、ガード追加の妥当性、ロギングの最小性、命名とスタイル統一。
  - リスクと対策: ガード追加による副作用（早期リターン過剰）→ 既存テストでカバー、影響範囲を限定・差分最小化。

---

## チェックボックス付き実装計画書

**実装計画立案ルール**
- 詳細なステップバイステップの計画書
- とにかく小さい単位
- 明確な開始と終了がある
- １つの関心事に集中

## 計画書

- 準備
  - [x] ベースライン取得: 現行ブランチとテストの緑確認（`npm run test` 実行記録）
    - **完了**: Tests: 47, Assertions: 156, Skipped: 2 - 全テスト成功
  - [x] 差分範囲の固定: フェーズ6で触る関数・ファイル一覧の確定（本計画に追記）
    - **対象ファイル**: `localize-debug-log/localize-debug-log.php`（単一ファイル構成）
    - **対象関数**:
      - `ldl_validate_log_path` (Line 603): パス検証機能
      - `ldl_delete_log_file` (Line 457): ログ削除機能
      - `ldl_handle_delete_request` (Line 511): 削除リクエスト処理
      - `ldl_render_log_page` (Line 401): ログ表示画面
      - `ldl_extract_utc_timestamp` (Line 206): ログ解析（Phase 5で一部修正済み）
    - **総関数数**: 23関数（全てldl_プレフィックス統一済み）
    - **ドキュメント**: `_doc/_TechSpec.md`, `_doc/_Structure.md`, `_doc/_Milestone.md`, `localize-debug-log/readme.md`

- エラーハンドリング強化（TDD・機能単位）
  - `ldl_validate_log_path`
    - [x] Red: 無効入力の網羅（null/空/非文字列/親ディレクトリ侵入）テストを追加
      - **完了**: `2025-08-11_phase6_validate_path_enhanced_Test.php` に5つの詳細テストを追加
      - **テスト数**: 52個のテスト（+5個）、225個のアサーション
      - **テスト内容**: 型チェック、ディレクトリトラバーサル、エッジケース、正常系境界、関数存在確認
    - [x] Green: 既存実装での合否を確認（失敗時は安全側へ最小修正）
      - **結果**: 全テスト成功、現在の実装は既に適切なエラーハンドリングを実装済み
      - **Phase 5修正の効果**: 無限ループ修正・入力ガード追加により堅牢性が向上済み
    - [ ] Refactor: ガード分岐の可読性向上（挙動不変）
  - `ldl_delete_log_file`
    - [x] Red: 権限不足/ファイル不存在/書込不可時の挙動テスト（戻り値・ファイル状態）
      - **完了**: `2025-08-11_phase6_delete_file_enhanced_Test.php` に6つの詳細テストを追加
      - **テスト数**: 58個のテスト（+6個）、323個のアサーション（+98個）
      - **テスト内容**: 無効パス・非文字列引数・ファイル操作失敗・戻り値一貫性・例外安全性確認
    - [x] Green: 正常・異常の分岐が仕様通りであることを保証（必要最小修正）
      - **結果**: 全テスト成功、既存実装は適切な多段階フォールバック・例外安全性を実装済み
    - [x] Refactor: 早期リターン整理と排他制御コメント整備（コード挙動不変）
      - **完了**: Step 1-5の処理フロー明確化、TOCTOU攻撃対策・排他制御・例外安全性の説明を追加
  - `ldl_handle_delete_request`
    - [ ] Red: 非POST/nonce不正/権限不足時に削除されないことのテスト
    - [ ] Green: 現行仕様に合わせた分岐確認（必要最小修正）
    - [ ] Refactor: 条件式の意図を表す変数抽出（挙動不変）
  - `ldl_render_log_page`
    - [ ] Red: 大容量/不可読ファイル時もUI構造（要素・属性）が不変であることのテスト
    - [ ] Green: 既存出力と一致（差分があれば仕様側で要否判断→原則不変を優先）
    - [ ] Refactor: テンプレートのエスケープ責務の見直し（コード挙動不変）
  - 共通
    - [ ] Red: 例外/Warning/Deprecatedが出ないことの捕捉テスト（エッジケース）
    - [ ] Green: 非推奨・例外ゼロを確認
    - [ ] Refactor: 重複ガードの共通化検討（導入は差分最小・挙動不変が担保できる範囲のみ）

- コード品質チェック（命名・規約）
  - `ldl_`プレフィックス統一
    - [ ] チェック: 関数・フックハンドラ・グローバルの`ldl_`接頭辞スキャン（grep/簡易スクリプト）
    - [ ] 修正: 例外が見つかった場合のみリネーム（公開APIへの影響ゼロを確認）
    - [ ] テスト: 影響箇所の呼び出しテストを更新/追加（名前以外の挙動不変）
  - WordPress Coding Standards（追加依存なし方針）
    - [ ] チェック: インデント、ネーミング、国際化（必要箇所のみ）を静的レビュー
    - [ ] 修正: 自動整形なしで安全な範囲のスタイル修正（差分最小）
    - [ ] 確認: 影響なしをテストで再確認

- ドキュメント最終化（仕様を正とする）
  - [ ] 整合チェック: `_doc/_TechSpec.md` ↔ `_doc/_Structure.md` ↔ `_doc/_Milestone.md` ↔ `localize-debug-log/readme.md`
  - [ ] 用語・関数名統一: `ldl_`関数表の最終版を仕様に反映
  - [ ] マイルストーン更新: 本フェーズ結果と指標達成の反映

- 最終動作テスト（ステージング）
  - [ ] セットアップ: ステージング環境条件の明文化（PHP 8.3/WordPress推奨設定/権限）
  - [ ] シナリオ: ログ出力→閲覧→削除→再出力の一連動作確認
  - [ ] セキュリティ: 非管理者UIアクセス不能、CSRF防御の挙動確認
  - [ ] 記録: 実行結果・スクリーンショット（必要時）・承認の記録

- リリースゲート（完了条件の検証）
  - [ ] テスト緑・警告ゼロの再確認
  - [ ] 規約・命名逸脱ゼロの確認ログ添付
  - [ ] ドキュメント更新差分のレビュー承認

---

## コミットコメント
{{実装チェックリストが完了後、ユーザーの明確な承認を得たあとでチャットに出力されたコミットコメントを記載}}
