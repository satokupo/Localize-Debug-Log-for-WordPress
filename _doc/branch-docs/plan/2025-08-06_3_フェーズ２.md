# Phase 2: コア機能実装（ログ収集・処理）

## 要件定義

### 🎯 概要説明
WordPress プラグイン「Localize Debug Log for WordPress」のコア機能であるログ収集・処理システムを実装します。PHP の `error_log()` 出力先をプラグイン制御下に統一し、WordPress のタイムゾーン設定に基づいたローカル時刻表示機能を構築します。技術仕様書に定義された 3つの中核機能（出力先変更・タイムゾーン処理・ログ整形）の実装がスコープです。

### 📍 現在地
- **Phase 1完了**: プラグイン基盤構築完了（2025-08-06）
  - メインプラグインファイル骨格: `localize-debug-log.php` 作成済み
  - セキュリティ基盤: `logs/.htaccess` 設置済み
  - ライセンス・ドキュメント: LICENSE、readme.md 整備済み
- **開発環境**: PHPUnitテスト環境、npm scripts、Git環境すべて稼働中
- **Phase 2実装**: 未着手（コード部分は骨格のみ）
- **作業ブランチ**: feature/phase2-core-functions で実装予定

### 🎯 ゴール
**最終的に達成される動作:**
1. **ログ統一化**: `error_log('test message')` 実行時、必ず `logs/debug.log` に出力される
2. **タイムゾーン表示**: ログ閲覧時、各行の先頭に WordPress設定のローカル時刻が付加される
3. **動作確認**: プラグイン有効化後、即座にログ収集・表示機能が稼働する

**具体的な出力例:**
```
JST 2025/01/06 15:30:45 | [06-Jan-2025 06:30:45 UTC] test message
JST 2025/01/06 15:31:02 | [06-Jan-2025 06:31:02 UTC] PHP Notice: undefined variable
```

### 🔧 方針
**技術方針:**
- **WordPress公式API限定**: `ini_set()`, `add_filter()`, `get_option()` 等の公式機能のみ使用
- **非侵襲原則**: wp-config.php、.htaccess（サイトルート）等のコアファイルは一切変更しない
- **ファイル保護**: logs/debug.log の内容は読み取り専用、書き換え・削除は行わない（Phase 2では）
- **即時有効化**: プラグイン有効化と同時にログ収集開始（設定画面不要）

**実装順序原則:**
1. ログ出力先変更機能（最優先）
2. タイムゾーン処理ロジック
3. ログ読み込み・整形機能
※ 管理画面UIは Phase 3 で実装

### 📁 作業対象ファイルの構造可視化(tree)
```
localize-debug-log/
├── localize-debug-log.php          # 実装対象（中核ファイル）
│   ├── [実装予定] プラグイン初期化処理
│   ├── [実装予定] ログ出力先変更機能
│   ├── [実装予定] タイムゾーン処理関数
│   └── [実装予定] ログ読み込み・整形関数
├── logs/                           # ログ保存領域（既存）
│   ├── debug.log                   # error_log() 出力先（自動生成）
│   └── .htaccess                   # セキュリティ設定（既存）
├── readme.md                       # プラグイン説明（既存）
└── LICENSE                         # ライセンス（既存）
```

### 💡 実装方針詳細

**1. error_log()出力先変更機能:**
- **フック**: `plugins_loaded` アクション（優先度: 0）で即座に実行
- **ini_set()設定**: `ini_set('error_log', plugin_dir_path(__FILE__) . 'logs/debug.log')`
- **フィルタ実装**: `add_filter('debug_log_path', 'ldl_override_debug_log_path')` でWordPressコア出力も制御
- **ディレクトリ生成**: `wp_mkdir_p()` による logs ディレクトリ自動作成

**2. タイムゾーン処理ロジック:**
- **優先順位**: `get_option('timezone_string')` → `get_option('gmt_offset')` → UTC
- **DateTime活用**: `DateTimeZone` クラスによる正確な時刻変換
- **技術仕様書準拠**: 仕様書4章の処理ロジックを完全実装
```php
// 実装例（技術仕様書4章より）
$tz_string = get_option('timezone_string');
if (empty($tz_string)) {
    $offset = get_option('gmt_offset');
    $tz_string = sprintf('Etc/GMT%+d', -$offset);
}
$tz = new DateTimeZone($tz_string);
```

**3. ログ読み込み・整形機能:**
- **読み込み方式**: `file_get_contents()` による全体読み込み（Phase 2では分割読み込み未対応）
- **行解析**: 正規表現によるタイムスタンプ検出 `\[(\d{2}-\w{3}-\d{4} \d{2}:\d{2}:\d{2}) UTC\]`
- **整形処理**: 各行先頭にローカル時刻追加、元UTC時刻は保持

### ⚠️ 絶対変更禁止項目
**ファイル・ディレクトリレベル:**
- `logs/debug.log` の内容改変（読み取り専用、表示時整形のみ）
- `wp-config.php` 等のWordPressコアファイル編集
- サイトルートの `.htaccess` 編集
- `logs/.htaccess` の既存セキュリティ設定変更

**コード実装レベル:**
- Phase 1で完成したファイル群（readme.md、LICENSE、logs/.htaccess）の変更
- 管理画面UI関連の実装（Phase 3で実装予定）
- セキュリティ・権限制御機能（Phase 4で実装予定）
- テスト実装（Phase 5で実装予定）

**設計・仕様レベル:**
- 技術仕様書のバージョン要件変更（WordPress 5.1+、PHP 7.4+）
- 関数プレフィックス `ldl_` 以外の使用
- 外部ライブラリ・Composer依存の追加

### 📊 成功条件（検証可能）

**1. ログ出力先変更成功条件:**
- [ ] プラグイン有効化後、`error_log('Phase2テスト')` 実行で `logs/debug.log` にメッセージが記録される
- [ ] 他のプラグインの `error_log()` も同じファイルに集約される
- [ ] WordPress自体のエラーログも `logs/debug.log` に出力される
- [ ] `ini_get('error_log')` で正しいパスが返される

**2. タイムゾーン処理成功条件:**
- [ ] WordPress管理画面で「Asia/Tokyo」設定時、`JST 2025/01/06 15:30:45` 形式で表示される
- [ ] `gmt_offset` のみ設定時（+9）、適切にタイムゾーン名が表示される
- [ ] タイムゾーン未設定時、`UTC` として表示され、エラーが発生しない
- [ ] サマータイム期間中も正確な時刻変換が行われる

**3. ログ整形機能成功条件:**
- [ ] 既存ログファイルを読み込み、各行にローカル時刻が先頭追加される
- [ ] 元のUTC時刻 `[06-Jan-2025 06:30:45 UTC]` が保持される
- [ ] ログファイルが存在しない場合、エラーではなく空結果を返す
- [ ] 1MB程度のログファイルでも正常に処理される（Performance確認）

**4. 統合動作成功条件:**
- [ ] プラグイン有効化→error_log()実行→ログ確認の一連動作が正常完了
- [ ] 他プラグインとの同時動作で競合が発生しない
- [ ] WordPress標準のデバッグ設定（WP_DEBUG等）と協調動作する

---

## チェックボックス付き実装計画書

**実装計画立案ルール**
- 詳細なステップバイステップの計画書
- とにかく小さい単位
- 明確な開始と終了がある
- １つの関心事に集中

## 計画書

### 📋 Phase 2: コア機能実装チェックリスト

**🧪 TDD適用判断（最小限アプローチ）**
- ログ出力先変更: 基本設定のため軽量テストのみ
- タイムゾーン処理: 核心ロジックのみTDD適用（時刻変換部分）
- ログ整形機能: 主要パターンのみテスト（標準ログ形式中心）
- **方針**: 過剰テスト回避、核心機能に集中

#### 🔧 1. 開発環境準備・基盤確認
- [ ] 開発環境の動作確認
  - [ ] `npm run test` で PHPUnit が正常実行されることを確認
  - [ ] プロジェクトルートから実行し、エラーがないことを確認
  - [ ] `dev/tests/active/` ディレクトリが存在し、書き込み可能であることを確認
- [ ] WordPress関数モック環境のセットアップ（軽量アプローチ）
  - [ ] `composer require --dev 10up/wp_mock` でWP_Mock追加
  - [ ] `dev/tests/bootstrap.php` にWP_Mock初期化処理追加
  - [ ] WordPress関数（`get_option()` 等）のモック機能有効化
- [ ] Phase 2実装範囲の再確認
  - [ ] 要件定義書の成功条件を再読み込み
  - [ ] 技術仕様書 4章（タイムゾーン処理）の内容確認
  - [ ] 絶対変更禁止項目の再確認（管理画面UI等は Phase 3）

#### 🧪 2. テストファイル作成・テストケース設計

**WordPress環境テスト方針（軽量アプローチ）:**
- WP_Mockを利用してWordPress関数をモック化
- `get_option()`, `wp_mkdir_p()` 等は期待値を返すモック設定
- ファイルシステム操作は実際のテンポラリディレクトリ使用
- **過剰テスト回避**: 核心ロジックのみテスト、DB操作等は除外
- [ ] タイムゾーン処理テストファイル作成（核心機能のみ）
  - [ ] `dev/tests/active/2025-08-06_timezone_processing_Test.php` 作成
  - [ ] 基本的なテストケース設計
    - [ ] `timezone_string` 設定時（Asia/Tokyo）のテストケース
    - [ ] `gmt_offset` 設定時（+9）のテストケース
    - [ ] 未設定時（UTC）のフォールバックテストケース
- [ ] ログ出力先変更テストファイル作成（基本動作のみ）
  - [ ] `dev/tests/active/2025-08-06_log_redirection_Test.php` 作成
  - [ ] パス取得の正常動作テストケース
  - [ ] ディレクトリ作成の基本テストケース
- [ ] ログ整形機能テストファイル作成（主要パターンのみ）
  - [ ] `dev/tests/active/2025-08-06_log_formatting_Test.php` 作成
  - [ ] 基本的なログ形式テストケース設計
    - [ ] 標準 error_log 形式（UTC時刻付き）のテストケース
    - [ ] ローカル時刻追加の正常動作テストケース

#### ✨ 3. コア関数実装：タイムゾーン処理（TDD）
- [ ] タイムゾーン処理関数の実装
  - [ ] `ldl_get_wordpress_timezone()` 関数作成
    - [ ] テストを先に作成（Red段階）
    - [ ] `get_option('timezone_string')` 優先処理の実装
    - [ ] `get_option('gmt_offset')` フォールバック処理の実装
    - [ ] テスト合格確認（Green段階）
    - [ ] コードリファクタリング（Refactor段階）
  - [ ] `ldl_convert_utc_to_local()` 関数作成
    - [ ] UTCタイムスタンプ→ローカル時刻変換のテスト作成
    - [ ] DateTimeクラス使用の実装
    - [ ] タイムゾーン名表示（JST等）の実装
    - [ ] 精度テスト・リファクタリング
  - [ ] `ldl_format_local_timestamp()` 関数作成
    - [ ] 出力形式のテスト作成（JST 2025/01/06 15:30:45 形式）
    - [ ] 実装・テスト合格・リファクタリング
- [ ] タイムゾーン処理統合テスト実行
  - [ ] `npm run test` で作成したテストが全て合格することを確認
  - [ ] エラーケースもカバーされていることを確認

#### 🔄 4. コア関数実装：ログ出力先変更
- [ ] ログパス取得関数の実装
  - [ ] `ldl_get_log_path()` 関数作成
    - [ ] `plugin_dir_path(__FILE__) . 'logs/debug.log'` 返却のテスト作成
    - [ ] 実装・テスト合格確認
  - [ ] `ldl_ensure_log_directory()` 関数作成
    - [ ] `wp_mkdir_p()` によるディレクトリ作成のテスト
    - [ ] 権限チェックとエラーハンドリングのテスト
    - [ ] 実装・テスト合格・リファクタリング
- [ ] ログ出力先変更機能の実装
  - [ ] `ldl_setup_error_log_redirection()` 関数作成
    - [ ] `ini_set('error_log', ...)` のテスト作成
    - [ ] 実装・動作確認
  - [ ] `ldl_override_debug_log_path()` フィルタ関数作成
    - [ ] `debug_log_path` フィルタのテスト作成
    - [ ] 実装・テスト合格確認
- [ ] プラグイン初期化処理の実装
  - [ ] `ldl_init()` 関数作成
  - [ ] `plugins_loaded` フック登録（優先度 0）の実装
  - [ ] ログ出力先変更の即座実行確認

#### 📖 5. コア関数実装：ログ読み込み・整形機能（TDD）
- [ ] ログファイル読み込み関数の実装
  - [ ] `ldl_read_log_file()` 関数作成
    - [ ] ファイル存在チェックのテスト作成
    - [ ] `file_get_contents()` 読み込みのテスト
    - [ ] エラー時の空配列返却テスト
    - [ ] 実装・テスト合格・リファクタリング
- [ ] ログ行解析関数の実装
  - [ ] `ldl_parse_log_lines()` 関数作成
    - [ ] UTC タイムスタンプ抽出の正規表現テスト作成
    - [ ] パターン: `\[(\d{2}-\w{3}-\d{4} \d{2}:\d{2}:\d{2}) UTC\]`
    - [ ] 実装・テスト合格・リファクタリング
- [ ] ログ整形関数の実装
  - [ ] `ldl_format_log_with_local_time()` 関数作成
    - [ ] 各行先頭へのローカル時刻追加テスト作成
    - [ ] 出力形式: `JST 2025/01/06 15:30:45 | [原文]`
    - [ ] 複数行・特殊文字対応のテスト作成
    - [ ] 実装・テスト合格・リファクタリング

#### 🔗 6. 機能統合・プラグイン有効化処理
- [ ] メインプラグインファイルの実装
  - [ ] `localize-debug-log.php` に全関数統合
  - [ ] プラグイン有効化時の初期化処理実装
  - [ ] `ldl_` プレフィックス統一確認
- [ ] プラグイン初期化処理の統合
  - [ ] `plugins_loaded` フック登録による自動実行
  - [ ] エラー時の基本的なフォールバック処理
- [ ] 統合動作テストの実行
  - [ ] プラグイン有効化→`error_log('test')`→ログ確認の一連テスト
  - [ ] WP_DEBUG設定との相互不可侵動作確認（理論上の確認）
    - [ ] WP_DEBUG設定値を変更しないことをコードで確認
    - [ ] WP_DEBUG_LOG設定値を変更しないことをコードで確認
    - [ ] WP_DEBUG_DISPLAY設定値を変更しないことをコードで確認
    - [ ] エラー時の適切なフォールバック動作確認

#### ✅ 7. 品質保証・最終確認
- [ ] コード品質チェック
  - [ ] 全関数に `ldl_` プレフィックスが付与されているか確認
  - [ ] PHPDoc コメントの適切な記述確認
  - [ ] WordPress コーディング規約準拠確認
- [ ] 全テストスイート実行
  - [ ] `npm run test` で全テストが合格することを確認
  - [ ] テストカバレッジの確認（主要パス網羅）
  - [ ] エラーケースの適切な処理確認
- [ ] 機能動作確認（手動テスト）
  - [ ] プラグイン有効化・無効化の動作確認
  - [ ] `error_log()` 出力が `logs/debug.log` に記録されることを確認
  - [ ] 様々なタイムゾーン設定での表示確認
  - [ ] 大容量ログファイル（1MB程度）での性能確認
- [ ] 実装完了確認
  - [ ] 実装したコードにコメント追記
  - [ ] Phase 2完了の最終確認（マイルストーン項目と照合）


