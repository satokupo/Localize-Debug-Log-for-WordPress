# Phase 2: コア機能実装（ログ収集・処理）

## 要件定義

### 🎯 概要説明
WordPress プラグイン「Localize Debug Log for WordPress」のコア機能であるログ収集・処理システムを実装します。PHP の `error_log()` 出力先をプラグイン制御下に統一し、WordPress のタイムゾーン設定に基づいたローカル時刻表示機能を構築します。技術仕様書に定義された 3つの中核機能（出力先変更・タイムゾーン処理・ログ整形）の実装がスコープです。

### 📍 現在地
- **Phase 1完了**: プラグイン基盤構築完了（2025-08-06）
  - メインプラグインファイル骨格: `localize-debug-log.php` 作成済み
  - セキュリティ基盤: `logs/.htaccess` 設置済み
  - ライセンス・ドキュメント: LICENSE、readme.md 整備済み
- **開発環境**: PHPUnitテスト環境、npm scripts、Git環境すべて稼働中
- **Phase 2実装**: 未着手（コード部分は骨格のみ）
- **作業ブランチ**: feature/phase2-core-functions で実装予定

### 🎯 ゴール
**最終的に達成される動作:**
1. **ログ統一化**: `error_log('test message')` 実行時、必ず `logs/debug.log` に出力される
2. **タイムゾーン表示**: ログ閲覧時、各行の先頭に WordPress設定のローカル時刻が付加される
3. **動作確認**: プラグイン有効化後、即座にログ収集・表示機能が稼働する

**具体的な出力例:**
```
JST 2025/01/06 15:30:45 | [06-Jan-2025 06:30:45 UTC] test message
JST 2025/01/06 15:31:02 | [06-Jan-2025 06:31:02 UTC] PHP Notice: undefined variable
```

### 🔧 方針
**技術方針:**
- **WordPress公式API限定**: `ini_set()`, `add_filter()`, `get_option()` 等の公式機能のみ使用
- **非侵襲原則**: wp-config.php、.htaccess（サイトルート）等のコアファイルは一切変更しない
- **ファイル保護**: logs/debug.log の内容は読み取り専用、書き換え・削除は行わない（Phase 2では）
- **即時有効化**: プラグイン有効化と同時にログ収集開始（設定画面不要）

**実装順序原則:**
1. ログ出力先変更機能（最優先）
2. タイムゾーン処理ロジック
3. ログ読み込み・整形機能
※ 管理画面UIは Phase 3 で実装

### 📁 作業対象ファイルの構造可視化(tree)
```
localize-debug-log/
├── localize-debug-log.php          # 実装対象（中核ファイル）
│   ├── [実装予定] プラグイン初期化処理
│   ├── [実装予定] ログ出力先変更機能
│   ├── [実装予定] タイムゾーン処理関数
│   └── [実装予定] ログ読み込み・整形関数
├── logs/                           # ログ保存領域（既存）
│   ├── debug.log                   # error_log() 出力先（自動生成）
│   └── .htaccess                   # セキュリティ設定（既存）
├── readme.md                       # プラグイン説明（既存）
└── LICENSE                         # ライセンス（既存）
```

### 💡 実装方針詳細

**1. error_log()出力先変更機能:**
- **フック**: `plugins_loaded` アクション（優先度: 0）で即座に実行
- **ini_set()設定**: `ini_set('error_log', plugin_dir_path(__FILE__) . 'logs/debug.log')`
- **フィルタ実装**: `add_filter('debug_log_path', 'ldl_override_debug_log_path')` でWordPressコア出力も制御
- **ディレクトリ生成**: `wp_mkdir_p()` による logs ディレクトリ自動作成

**2. タイムゾーン処理ロジック:**
- **優先順位**: `get_option('timezone_string')` → `get_option('gmt_offset')` → UTC
- **DateTime活用**: `DateTimeZone` クラスによる正確な時刻変換
- **技術仕様書準拠**: 仕様書4章の処理ロジックを完全実装
```php
// 実装例（技術仕様書4章より）
$tz_string = get_option('timezone_string');
if (empty($tz_string)) {
    $offset = get_option('gmt_offset');
    $tz_string = sprintf('Etc/GMT%+d', -$offset);
}
$tz = new DateTimeZone($tz_string);
```

**3. ログ読み込み・整形機能:**
- **読み込み方式**: `file_get_contents()` による全体読み込み（Phase 2では分割読み込み未対応）
- **行解析**: 正規表現によるタイムスタンプ検出 `\[(\d{2}-\w{3}-\d{4} \d{2}:\d{2}:\d{2}) UTC\]`
- **整形処理**: 各行先頭にローカル時刻追加、元UTC時刻は保持

### ⚠️ 絶対変更禁止項目
**ファイル・ディレクトリレベル:**
- `logs/debug.log` の内容改変（読み取り専用、表示時整形のみ）
- `wp-config.php` 等のWordPressコアファイル編集
- サイトルートの `.htaccess` 編集
- `logs/.htaccess` の既存セキュリティ設定変更

**コード実装レベル:**
- Phase 1で完成したファイル群（readme.md、LICENSE、logs/.htaccess）の変更
- 管理画面UI関連の実装（Phase 3で実装予定）
- セキュリティ・権限制御機能（Phase 4で実装予定）
- テスト実装（Phase 5で実装予定）

**設計・仕様レベル:**
- 技術仕様書のバージョン要件変更（WordPress 5.1+、PHP 7.4+）
- 関数プレフィックス `ldl_` 以外の使用
- 外部ライブラリ・Composer依存の追加

### 📊 成功条件（検証可能）

**1. ログ出力先変更成功条件:**
- [ ] プラグイン有効化後、`error_log('Phase2テスト')` 実行で `logs/debug.log` にメッセージが記録される
- [ ] 他のプラグインの `error_log()` も同じファイルに集約される
- [ ] WordPress自体のエラーログも `logs/debug.log` に出力される
- [ ] `ini_get('error_log')` で正しいパスが返される

**2. タイムゾーン処理成功条件:**
- [ ] WordPress管理画面で「Asia/Tokyo」設定時、`JST 2025/01/06 15:30:45` 形式で表示される
- [ ] `gmt_offset` のみ設定時（+9）、適切にタイムゾーン名が表示される
- [ ] タイムゾーン未設定時、`UTC` として表示され、エラーが発生しない
- [ ] サマータイム期間中も正確な時刻変換が行われる

**3. ログ整形機能成功条件:**
- [ ] 既存ログファイルを読み込み、各行にローカル時刻が先頭追加される
- [ ] 元のUTC時刻 `[06-Jan-2025 06:30:45 UTC]` が保持される
- [ ] ログファイルが存在しない場合、エラーではなく空結果を返す
- [ ] 1MB程度のログファイルでも正常に処理される（Performance確認）

**4. 統合動作成功条件:**
- [ ] プラグイン有効化→error_log()実行→ログ確認の一連動作が正常完了
- [ ] 他プラグインとの同時動作で競合が発生しない
- [ ] WordPress標準のデバッグ設定（WP_DEBUG等）と協調動作する

---

## チェックボックス付き実装計画書

**実装計画立案ルール**
- 詳細なステップバイステップの計画書
- とにかく小さい単位
- 明確な開始と終了がある
- １つの関心事に集中

## 計画書
（※ユーザーからの要件定義承認後に記述）

---

## コミットコメント
（※実装チェックリストが完了し、ユーザー承認後に記述）
